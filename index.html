<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£å¥½é³¥ - Taiwan Good Bird (OSMç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        /* === 1. åŸºç¤é‡ç½®èˆ‡ä½ˆå±€ === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f0f2f5; }
        
        .container { display: flex; flex-direction: row; height: 100%; width: 100%; position: relative; }
        
        /* å·¦å´æ¬„ä½ */
        .sidebar-left { 
            width: 340px; background: white; display: flex; flex-direction: column; 
            border-right: 1px solid #ddd; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            height: 100%; flex-shrink: 0; 
        }
        
        /* ä¸­é–“åœ°åœ– (Leaflet å®¹å™¨) */
        #map { flex-grow: 1; height: 100%; z-index: 1; background: #aad3df; }
        
        /* å³å´æ¬„ä½ */
        .sidebar-right { 
            width: 300px; background: #fff; border-left: 1px solid #ddd; 
            display: flex; flex-direction: column; z-index: 1000; height: 100%; flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        /* === 2. å…ƒä»¶æ¨£å¼ === */
        .header { padding: 15px; background: #2c3e50; color: white; text-align: center; font-weight: bold; font-size: 1.2rem; }
        
        .tabs { display: flex; background: #ecf0f1; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #7f8c8d; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { color: #2c3e50; border-bottom: 3px solid #2c3e50; background: #fff; }

        .list-container { flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        
        .loc-card { 
            background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-left: 4px solid #3498db; 
        }
        .loc-card:hover { background-color: #f9f9f9; }
        .loc-name { font-weight: bold; font-size: 1rem; color: #2c3e50; margin-bottom: 5px; }
        .loc-meta { font-size: 0.85rem; color: #7f8c8d; display: flex; justify-content: space-between; align-items: center; }
        .count-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }

        .bird-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; overflow-y: auto; flex: 1; }
        .bird-grid-item { 
            display: flex; flex-direction: column; align-items: center; text-align: center; 
            cursor: pointer; padding: 5px; border-radius: 6px; border: 1px solid transparent; 
        }
        .bird-grid-item.active { background: #e8f6fd; border-color: #3498db; }
        .bird-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; margin-bottom: 5px; }
        .bird-name { font-size: 0.8rem; color: #333; line-height: 1.2; }

        .detail-panel { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 2000; display: none; flex-direction: column; 
        }
        .detail-header { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; background: #f8f9fa; }
        .back-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 0 15px; color: #2c3e50; }
        .detail-content { flex: 1; overflow-y: auto; padding: 15px; }

        .obs-item { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .obs-img { width: 80px; height: 80px; border-radius: 6px; object-fit: cover; background: #eee; flex-shrink: 0; }
        .obs-info { flex: 1; min-width: 0; }
        .obs-bird { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        .obs-time { font-size: 0.8rem; color: #888; margin: 2px 0; }
        .obs-desc { font-size: 0.85rem; color: #555; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .mobile-search-btn {
            display: none; position: fixed; top: 15px; right: 15px; z-index: 3000;
            background: white; padding: 8px 15px; border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold; color: #2c3e50;
            border: 1px solid #ddd; cursor: pointer;
        }

        /* === 3. RWD æ‰‹æ©Ÿç‰ˆé…ç½® === */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            #map { width: 100%; height: 40%; order: 1; }
            .sidebar-left { width: 100%; height: 60%; order: 2; border-right: none; border-top: 2px solid #ddd; z-index: 1500; }
            .sidebar-right { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; }
            .mobile-search-btn { display: flex; align-items: center; gap: 5px; }
            .detail-panel { height: 100%; }
        }
    </style>
</head>
<body>

<div class="mobile-search-btn" onclick="toggleMobileSearch()">ğŸ” æ‰¾é³¥ç¨®</div>

<div class="container">
    <div class="sidebar-left">
        <div class="header">ğŸ¦ å°ç£å¥½é³¥åœ°åœ–</div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('record')">è¿‘æœŸç´€éŒ„</div>
            <div class="tab" onclick="switchTab('hotspot')">è³é³¥ç†±é»</div>
        </div>
        
        <div id="location-list-container" class="list-container">
            <div style="padding:20px; text-align:center; color:#999;">è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>
        <div id="hotspot-list-container" class="list-container" style="display:none;"></div>
        
        <div id="location-detail-panel" class="detail-panel">
            <div class="detail-header">
                <button class="back-btn" onclick="closeDetail()">â¬…</button>
                <h3 id="detail-title" style="margin:0; font-size:1.1rem;">åœ°é»è©³æƒ…</h3>
            </div>
            <div id="detail-body" class="detail-content"></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="sidebar-right" id="sidebar-right">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; gap:10px; background:#f8f9fa;">
            <button onclick="toggleMobileSearch()" style="border:none; background:none; font-size:1.2rem; cursor:pointer; display:none;" id="mobile-close-btn">âœ–</button>
            <input type="text" id="bird-search" placeholder="æœå°‹é³¥ç¨®..." 
                   style="flex:1; padding:10px; border:1px solid #ddd; border-radius:20px; outline:none;"
                   oninput="searchBirdGrid(this.value)">
        </div>
        <div id="bird-grid-container" class="bird-grid"></div>
        <div style="padding:10px; text-align:center; border-top:1px solid #eee;">
            <button onclick="resetFilter()" style="width:100%; padding:10px; background:#3498db; color:white; border:none; border-radius:6px; cursor:pointer;">é¡¯ç¤ºå…¨éƒ¨</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    let map;
    let markers; // MarkerClusterGroup
    let allBirdsData = {};
    let allRecentList = [];
    let allHotspotsList = [];
    let currentTab = 'record';
    let currentFilterCode = null;

    // è‡ªå®šç¾© Iconï¼šç¶ è‰²ç”¨æ–¼ç†±é»
    const greenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    // è—è‰²ç”¨æ–¼ä¸€èˆ¬ç´€éŒ„ (Leaflet é è¨­)
    const blueIcon = new L.Icon.Default();

    // 1. åˆå§‹åŒ– Leaflet åœ°åœ–
    function initMap() {
        console.log("åˆå§‹åŒ– Leaflet åœ°åœ–...");
        
        // å»ºç«‹åœ°åœ–å¯¦ä¾‹
        map = L.map('map', {
            zoomControl: false // æ‰‹æ©Ÿç‰ˆç¯€çœç©ºé–“ï¼Œå¯è¦–éœ€æ±‚é–‹å•Ÿ
        }).setView([23.9738, 120.9820], 8); // å°ç£ä¸­å¿ƒ

        // åŠ å…¥ OSM åœ–å±¤ (CartoDB Positron é¢¨æ ¼æ¯”è¼ƒä¹¾æ·¨ï¼Œä¹Ÿå¯ä»¥æ”¹ç”¨æ¨™æº– OSM)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // åˆå§‹åŒ–èšåˆå±¤
        markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        map.addLayer(markers);

        // è¼‰å…¥è³‡æ–™
        loadData();

        if(window.innerWidth <= 768) {
            document.getElementById('mobile-close-btn').style.display = 'block';
        }
    }

    // 2. è³‡æ–™è¼‰å…¥ (é‚è¼¯ä¸è®Š)
    async function loadData() {
        try {
            const response = await fetch('static/birds_data.json?v=' + new Date().getTime());
            if (!response.ok) throw new Error("æª”æ¡ˆè®€å–å¤±æ•—");
            
            const json = await response.json();
            allBirdsData = json;

            // æ‹å¹³è³‡æ–™çµæ§‹ (Flatten)
            if (Array.isArray(json.recent)) {
                allRecentList = json.recent;
            } else if (json.recent && typeof json.recent === 'object') {
                allRecentList = Object.values(json.recent).flat();
            } else {
                allRecentList = [];
            }

            if (json.hotspots && typeof json.hotspots === 'object') {
                allHotspotsList = Object.values(json.hotspots).flat();
            }

            console.log(`âœ… è¼‰å…¥æˆåŠŸï¼šè¿‘æœŸ ${allRecentList.length} ç­†ï¼Œç†±é» ${allHotspotsList.length} ç­†`);
            
            renderBirdGrid(allRecentList);
            renderMarkers(allRecentList, false);
            renderLocationList(allRecentList);

        } catch (error) {
            console.error(error);
            document.getElementById('location-list-container').innerHTML = 
                '<div style="padding:20px;text-align:center;color:red;">è³‡æ–™è¼‰å…¥å¤±æ•—</div>';
        }
    }

    // 3. æ¸²æŸ“åœ°é»åˆ—è¡¨
    function renderLocationList(data) {
        const container = document.getElementById('location-list-container');
        container.innerHTML = '';

        if (!data || data.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">æŸ¥ç„¡è³‡æ–™</div>';
            return;
        }

        const stats = {};
        data.forEach(item => {
            const name = item.locName || "æœªçŸ¥åœ°é»";
            if (!stats[name]) {
                stats[name] = { count: 0, lat: item.lat, lng: item.lng, county: item.county || "" };
            }
            stats[name].count++;
        });

        Object.entries(stats)
            .sort((a, b) => b[1].count - a[1].count)
            .forEach(([name, info]) => {
                const div = document.createElement('div');
                div.className = 'loc-card';
                div.innerHTML = `
                    <div class="loc-name">${name}</div>
                    <div class="loc-meta">
                        <span style="background:#eee; padding:2px 6px; border-radius:4px;">${info.county}</span>
                        <span class="count-badge">æ­¤åœ° ${info.count} ç­†ç´€éŒ„</span>
                    </div>
                `;
                div.onclick = () => {
                    // Leaflet: flyTo å¹³æ»‘ç§»å‹•
                    map.flyTo([parseFloat(info.lat), parseFloat(info.lng)], 15);
                    openLocationDetail(name, info.lat, info.lng);
                };
                container.appendChild(div);
            });
    }

    function renderHotspotList(data) {
        const container = document.getElementById('hotspot-list-container');
        container.innerHTML = '';
        data.forEach(spot => {
            const div = document.createElement('div');
            div.className = 'loc-card';
            div.style.borderLeftColor = '#27ae60';
            div.innerHTML = `
                <div class="loc-name">ğŸŒŸ ${spot.name}</div>
                <div class="loc-meta">${spot.desc || 'çŸ¥åè³é³¥é»'}</div>
            `;
            div.onclick = () => {
                map.flyTo([parseFloat(spot.lat), parseFloat(spot.lng)], 14);
                openHotspotDetail(spot);
            };
            container.appendChild(div);
        });
    }

    // 4. åœ°åœ– Marker (Leaflet ç‰ˆæœ¬)
    function renderMarkers(data, isHotspot) {
        markers.clearLayers(); // æ¸…é™¤èˆŠæ¨™è¨˜
        
        data.forEach(item => {
            const lat = parseFloat(item.lat);
            const lng = parseFloat(item.lng);
            if(isNaN(lat) || isNaN(lng)) return;

            const marker = L.marker([lat, lng], {
                icon: isHotspot ? greenIcon : blueIcon,
                title: item.name
            });

            // é»æ“Š Marker äº‹ä»¶
            marker.on('click', () => {
                if(isHotspot) openHotspotDetail(item);
                else openLocationDetail(item.locName, lat, lng);
            });
            
            // åŠ å…¥èšåˆå±¤
            markers.addLayer(marker);
        });
    }

    // 5. è©³æƒ…é  (èˆ‡èˆŠç‰ˆé‚è¼¯ç›¸åŒï¼Œåƒ… UI å‘ˆç¾)
    async function openLocationDetail(locName, lat, lng) {
        const panel = document.getElementById('location-detail-panel');
        document.getElementById('detail-title').innerText = locName;
        const body = document.getElementById('detail-body');
        
        panel.style.display = 'flex';
        body.innerHTML = '<div style="text-align:center; padding:20px;">è³‡æ–™è®€å–ä¸­...</div>';

        // å¤©æ°£
        let weatherHtml = '';
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,weathercode&forecast_days=1`);
            const data = await res.json();
            const hour = new Date().getHours();
            const temp = data.hourly.temperature_2m[hour];
            weatherHtml = `<div style="background:#e3f2fd; padding:10px; border-radius:6px; margin-bottom:15px; color:#1565c0;"><b>ğŸŒ¤ï¸ å³æ™‚å¤©æ°£ï¼š</b>${temp}Â°C</div>`;
        } catch(e) {}

        const birdsAtLoc = allRecentList.filter(b => b.locName === locName);
        let birdsHtml = '<h4>ğŸ‘€ è¿‘æœŸè§€æ¸¬ç´€éŒ„</h4>';
        
        if (birdsAtLoc.length === 0) {
            birdsHtml += '<p>ç„¡è©³ç´°ç´€éŒ„</p>';
        } else {
            birdsAtLoc.forEach(b => {
                const imgUrl = b.wikiImg || 'https://via.placeholder.com/80';
                const timeStr = b.date ? b.date.substring(5, 16) : '--';
                birdsHtml += `
                    <div class="obs-item">
                        <img src="${imgUrl}" class="obs-img" referrerpolicy="no-referrer">
                        <div class="obs-info">
                            <div class="obs-bird">${b.name}</div>
                            <div class="obs-time">ğŸ•’ ${timeStr}</div>
                            <div class="obs-desc">${b.wikiDesc || 'æš«ç„¡ç°¡ä»‹'}</div>
                        </div>
                    </div>
                `;
            });
        }
        body.innerHTML = weatherHtml + birdsHtml;
    }

    function openHotspotDetail(spot) {
        const panel = document.getElementById('location-detail-panel');
        document.getElementById('detail-title').innerText = spot.name;
        const body = document.getElementById('detail-body');
        panel.style.display = 'flex';

        let html = `<div style="background:#f0f9eb; padding:10px; border-radius:6px; margin-bottom:15px; color:#2e7d32;">${spot.desc}</div>`;
        html += '<h4>ğŸŒŸ ä»£è¡¨æ€§é³¥ç¨®</h4>';
        if (spot.potential && spot.potential.length > 0) {
            spot.potential.forEach(b => {
                const imgUrl = b.wikiImg || 'https://via.placeholder.com/80';
                html += `
                    <div class="obs-item">
                        <img src="${imgUrl}" class="obs-img" referrerpolicy="no-referrer">
                        <div class="obs-info">
                            <div class="obs-bird">${b.name}</div>
                            <div class="obs-desc">${b.wikiDesc || 'æš«ç„¡ç°¡ä»‹'}</div>
                        </div>
                    </div>
                `;
            });
        } else {
            html += '<p>å°šç„¡è³‡æ–™</p>';
        }
        body.innerHTML = html;
    }

    function closeDetail() { document.getElementById('location-detail-panel').style.display = 'none'; }

    // 6. æœå°‹èˆ‡éæ¿¾
    function filterBirds(speciesCode) {
        currentFilterCode = speciesCode;
        const filtered = allRecentList.filter(b => b.speciesCode === speciesCode);
        
        if (currentTab !== 'record') document.querySelectorAll('.tab')[0].click();
        
        renderMarkers(filtered, false);
        renderLocationList(filtered);
        
        document.querySelectorAll('.bird-grid-item').forEach(el => {
            el.classList.toggle('active', el.dataset.code === speciesCode);
        });

        if (window.innerWidth <= 768) toggleMobileSearch();
    }

    function resetFilter() {
        currentFilterCode = null;
        renderMarkers(allRecentList, false);
        renderLocationList(allRecentList);
        document.querySelectorAll('.bird-grid-item').forEach(el => el.classList.remove('active'));
        if (window.innerWidth <= 768) toggleMobileSearch();
    }

    function renderBirdGrid(data) {
        const container = document.getElementById('bird-grid-container');
        const unique = {};
        data.forEach(b => {
            if (!unique[b.speciesCode]) {
                unique[b.speciesCode] = { name: b.name, code: b.speciesCode, img: b.wikiImg };
            }
        });
        const sorted = Object.values(unique).sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
        
        let html = '';
        sorted.forEach(b => {
            const imgUrl = b.img || 'https://via.placeholder.com/60';
            html += `
                <div class="bird-grid-item" data-code="${b.code}" onclick="filterBirds('${b.code}')">
                    <img src="${imgUrl}" class="bird-img" referrerpolicy="no-referrer" loading="lazy">
                    <div class="bird-name">${b.name}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function searchBirdGrid(val) {
        document.querySelectorAll('.bird-grid-item').forEach(el => {
            el.style.display = el.innerText.includes(val) ? 'flex' : 'none';
        });
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('location-list-container').style.display = tab === 'record' ? 'block' : 'none';
        document.getElementById('hotspot-list-container').style.display = tab === 'hotspot' ? 'block' : 'none';
        closeDetail();
        
        if (tab === 'record') {
            const data = currentFilterCode ? allRecentList.filter(b=>b.speciesCode === currentFilterCode) : allRecentList;
            renderMarkers(data, false);
            renderLocationList(data);
        } else {
            renderMarkers(allHotspotsList, true);
            renderHotspotList(allHotspotsList);
        }
    }

    function toggleMobileSearch() {
        const el = document.getElementById('sidebar-right');
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    // å•Ÿå‹•
    initMap();

</script>

</body>
</html>
