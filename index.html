<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>å°ç£å¥½é³¥ - Taiwan Good Bird</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* === åŸºç¤è¨­å®š === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f0f2f5; }
        
        .container { display: flex; flex-direction: row; height: 100%; width: 100%; }
        
        /* å·¦å´åˆ—è¡¨æ¬„ä½ */
        .sidebar-left { 
            width: 380px; background: white; display: flex; flex-direction: column; 
            border-right: 1px solid #ddd; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            height: 100%; flex-shrink: 0; 
        }
        
        /* ä¸­é–“åœ°åœ–å€ */
        #map { flex-grow: 1; height: 100%; background: #aad3df; position: relative; }
        
        /* åœ°åœ–å·¦ä¸Šè§’æ§åˆ¶éˆ• */
        .map-controls {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            display: flex; gap: 8px;
        }
        .map-btn {
            background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px;
            padding: 8px 12px; cursor: pointer; font-weight: bold; color: #444;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3); font-size: 0.9rem;
            display: flex; align-items: center; gap: 6px;
        }
        .map-btn:hover { background: #f0f0f0; }

        /* å³å´æœå°‹æ¬„ */
        .sidebar-right { 
            width: 300px; background: #fff; border-left: 1px solid #ddd; 
            display: flex; flex-direction: column; z-index: 1000; height: 100%; flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        /* æ¨™é¡Œèˆ‡ Tabs */
        .header { padding: 15px; background: #2c3e50; color: white; text-align: center; font-weight: bold; font-size: 1.2rem; }
        .tabs { display: flex; background: #ecf0f1; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #7f8c8d; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { color: #2c3e50; border-bottom: 3px solid #2c3e50; background: #fff; }

        /* åˆ—è¡¨æ²å‹•å€ */
        .list-container { flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        
        /* === åœ°é»å¡ç‰‡ (Accordion æ‘ºç–Šæ¨£å¼) === */
        .loc-card { 
            background: white; border-radius: 8px; margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid #3498db; 
            overflow: hidden; transition: all 0.3s ease;
        }
        /* å¡ç‰‡æ¨™é¡Œ */
        .loc-header { padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .loc-header:hover { background-color: #f9f9f9; }
        .loc-name { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        .loc-meta { font-size: 0.85rem; color: #7f8c8d; }
        .count-badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        
        /* å¡ç‰‡è©³æƒ…å…§å®¹ (é è¨­éš±è—) */
        .loc-details { display: none; padding: 0 12px 12px 12px; border-top: 1px solid #eee; background: #fafafa; }
        /* å±•é–‹ç‹€æ…‹ */
        .loc-card.active .loc-details { display: block; }
        .loc-card.active { border-left-color: #e67e22; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* è©³æƒ…å…ƒä»¶ï¼šå¤©æ°£èˆ‡ç°¡ä»‹ */
        .weather-box { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.9rem; color: #2c3e50; }
        .loc-desc { color: #555; font-size: 0.95rem; margin-bottom: 15px; line-height: 1.6; background: white; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        
        /* === é³¥é¡ç´€éŒ„åˆ—è¡¨ (çµ±ä¸€ç‰ˆé¢) === */
        .bird-record { display: flex; gap: 10px; padding: 12px 0; border-bottom: 1px solid #eee; }
        .bird-record:last-child { border-bottom: none; }
        
        /* åœ–ç‰‡å®¹å™¨ï¼šæ­£æ–¹å½¢ã€ç°åº•ã€contain */
        .bird-thumb {
            width: 80px; height: 80px; flex-shrink: 0;
            background-color: #e0e0e0; border-radius: 6px; border: 1px solid #ccc;
            object-fit: contain; /* ç¢ºä¿åœ–ç‰‡ä¸è¢«è£åˆ‡ */
        }
        
        .bird-info { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        
        /* ç¬¬ä¸€è¡Œï¼šé³¥å + æ™‚é–“(é å³) */
        .bird-header-line { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
        .bird-name-txt { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        .bird-time-txt { font-size: 0.85rem; color: #d35400; font-weight: bold; font-family: monospace; }
        
        /* ç¬¬äºŒè¡Œï¼šç°¡ä»‹ */
        .bird-desc-txt { font-size: 0.85rem; color: #666; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* === å³å´ç¶²æ ¼ (ç„¡é™æ²å‹•) === */
        .bird-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; overflow-y: auto; flex: 1; }
        .bird-grid-item { 
            display: flex; flex-direction: column; align-items: center; text-align: center; 
            cursor: pointer; padding: 5px; border-radius: 6px; border: 1px solid transparent; 
        }
        .bird-grid-item.active { background: #e8f6fd; border-color: #3498db; }
        .bird-grid-img { 
            width: 70px; height: 70px; border-radius: 4px; object-fit: contain;
            background-color: #e0e0e0; margin-bottom: 5px; border: 1px solid #ccc;
        }
        .bird-grid-name { font-size: 0.8rem; color: #333; }

        /* æ‰‹æ©Ÿç‰ˆæœå°‹æŒ‰éˆ• */
        .mobile-search-btn {
            display: none; position: fixed; top: 15px; right: 15px; z-index: 3000;
            background: white; padding: 8px 15px; border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold; color: #2c3e50;
            border: 1px solid #ddd; cursor: pointer;
        }

        /* === åœ°åœ– Marker èˆ‡ æš«æ™‚åœ°æ¨™ === */
        /* è·³å‹•ç´…é» (Pulsing Marker) */
        .pulsing-marker {
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(231, 76, 60, 0.9);
            border: 3px solid white;
            box-shadow: 0 0 0 rgba(231, 76, 60, 0.4);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); transform: scale(0.95); }
            70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); transform: scale(1); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); transform: scale(0.95); }
        }

        /* å½©è‰²é³¥ ICON */
        .custom-bird-marker {
            display: flex; justify-content: center; align-items: center;
            width: 32px; height: 32px; border-radius: 50%;
            background: white; border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            color: white; font-size: 16px;
        }
        .bg-color-0 { background-color: #3498db; }
        .bg-color-1 { background-color: #e74c3c; }
        .bg-color-2 { background-color: #f1c40f; }
        .bg-color-3 { background-color: #9b59b6; }
        .bg-color-4 { background-color: #e67e22; }
        .bg-hotspot { background-color: #27ae60; border: 3px solid #fff; }

        /* RWD */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            #map { width: 100%; height: 40%; order: 1; }
            .sidebar-left { width: 100%; height: 60%; order: 2; border-right: none; border-top: 2px solid #ddd; z-index: 1500; }
            .sidebar-right { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; }
            .mobile-search-btn { display: flex; align-items: center; gap: 5px; }
            .map-controls { top: auto; bottom: 20px; left: 10px; flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="mobile-search-btn" onclick="toggleMobileSearch()">ğŸ” æ‰¾é³¥ç¨®</div>

<div class="container">
    <div class="sidebar-left">
        <div class="header">ğŸ¦ å°ç£å¥½é³¥åœ°åœ–</div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('record')">è¿‘æœŸç´€éŒ„</div>
            <div class="tab" onclick="switchTab('hotspot')">è³é³¥ç†±é»</div>
        </div>
        
        <div id="location-list-container" class="list-container">
            <div style="padding:20px; text-align:center; color:#999;">è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>
        <div id="hotspot-list-container" class="list-container" style="display:none;"></div>
    </div>

    <div id="map">
        <div class="map-controls">
            <div class="map-btn" onclick="resetMap()"><i class="fa-solid fa-house"></i> å›é¦–é </div>
            <div class="map-btn" onclick="locateUser()"><i class="fa-solid fa-location-crosshairs"></i> é™„è¿‘é³¥æ³</div>
        </div>
    </div>

    <div class="sidebar-right" id="sidebar-right">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; gap:10px; background:#f8f9fa;">
            <button onclick="toggleMobileSearch()" style="border:none; background:none; font-size:1.2rem; cursor:pointer; display:none;">âœ–</button>
            <input type="text" id="bird-search" placeholder="æœå°‹é³¥ç¨®..." 
                   style="flex:1; padding:10px; border:1px solid #ddd; border-radius:20px; outline:none;"
                   oninput="searchBirdGrid(this.value)">
        </div>
        <div id="bird-grid-container" class="bird-grid"></div>
        <div style="padding:10px; text-align:center; border-top:1px solid #eee;">
            <button onclick="resetFilter()" style="width:100%; padding:10px; background:#3498db; color:white; border:none; border-radius:6px; cursor:pointer;">é¡¯ç¤ºå…¨éƒ¨</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    let map, markers, selectedMarker = null;
    let allBirdsData = {};
    let allRecentList = [], allHotspotsList = [];
    let currentTab = 'record';
    let currentFilterCode = null;

    // ç„¡é™æ²å‹•è®Šæ•¸
    let displayedBirds = [];
    let loadIndex = 0;
    const LOAD_STEP = 50;

    // Marker é¡è‰²é‚è¼¯
    const getMarkerHtml = (name, isHotspot) => {
        if(isHotspot) return `<div class="custom-bird-marker bg-hotspot"><i class="fa-solid fa-tree"></i></div>`;
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return `<div class="custom-bird-marker bg-color-${Math.abs(hash % 5)}"><i class="fa-solid fa-dove"></i></div>`;
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([23.9738, 120.9820], 8);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

        markers = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 40 });
        map.addLayer(markers);
        loadData();

        // ç„¡é™æ²å‹•ç›£è½
        document.getElementById('bird-grid-container').addEventListener('scroll', function() {
            if(this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                loadMoreBirds();
            }
        });
    }

    async function loadData() {
        try {
            const res = await fetch('static/birds_data.json?v=' + Date.now());
            const json = await res.json();
            allBirdsData = json;
            
            // è³‡æ–™æ‹å¹³è™•ç† (Flattening)
            if (Array.isArray(json.recent)) allRecentList = json.recent;
            else if (typeof json.recent === 'object') allRecentList = Object.values(json.recent).flat();
            
            if (json.hotspots) allHotspotsList = Object.values(json.hotspots).flat();
            
            prepareBirdGrid(allRecentList); // æº–å‚™å³å´ç¶²æ ¼
            renderMarkers(allRecentList, false);
            renderLocationList(allRecentList);
        } catch (e) { console.error(e); }
    }

    // æ™‚é–“æ ¼å¼åŒ– (æœˆ/æ—¥ æ™‚:åˆ†)
    function formatDate(isoStr) {
        if(!isoStr) return '';
        // å‡è¨­ eBird æ ¼å¼ç‚º "2023-10-25 14:30"
        const parts = isoStr.split(' ');
        if(parts.length < 2) return isoStr.substring(5); // åªå‚³æ—¥æœŸå°±æˆªæ‰å¹´ä»½
        const datePart = parts[0].split('-');
        const timePart = parts[1].split(':');
        return `${datePart[1]}/${datePart[2]} ${timePart[0]}:${timePart[1]}`;
    }

    // 1. è¨­ç½®æš«æ™‚æ€§è·³å‹•åœ°æ¨™ (Highlight Marker)
    function setHighlightMarker(lat, lng) {
        if(selectedMarker) map.removeLayer(selectedMarker);
        const pulsingIcon = L.divIcon({
            className: 'pulsing-icon-container',
            html: '<div class="pulsing-marker"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        selectedMarker = L.marker([lat, lng], { icon: pulsingIcon, zIndexOffset: 1000 }).addTo(map);
    }

    // æ¸²æŸ“åœ°é»åˆ—è¡¨ (ç¾¤çµ„åŒ–)
    function renderLocationList(data) {
        const container = document.getElementById('location-list-container');
        container.innerHTML = '';
        if(!data || data.length === 0) { container.innerHTML = '<div style="padding:20px;text-align:center">æŸ¥ç„¡è³‡æ–™</div>'; return; }

        const stats = {};
        data.forEach(item => {
            const name = item.locName || "æœªçŸ¥åœ°é»";
            if (!stats[name]) stats[name] = { count: 0, lat: item.lat, lng: item.lng, county: item.county, items: [] };
            stats[name].count++;
            stats[name].items.push(item);
        });

        // æ’åºåœ°é» (ç­†æ•¸å¤šåˆ°å°‘)
        Object.entries(stats).sort((a,b) => b[1].count - a[1].count).forEach(([name, info]) => {
            // 3. æ’åºåœ°é»å…§çš„é³¥ç´€éŒ„ (ç”±æ–°åˆ°èˆŠ)
            info.items.sort((a, b) => new Date(b.date) - new Date(a.date));

            const div = document.createElement('div');
            div.className = 'loc-card';
            div.id = `loc-${name.replace(/\s+/g, '')}`; 
            
            div.innerHTML = `
                <div class="loc-header" onclick="toggleLocDetail(this, '${name}', ${info.lat}, ${info.lng})">
                    <div>
                        <div class="loc-name">${name}</div>
                        <div class="loc-meta"><span style="background:#eee;padding:1px 5px;border-radius:4px">${info.county || ''}</span></div>
                    </div>
                    <span class="count-badge">${info.count}</span>
                </div>
                <div class="loc-details"></div>
            `;
            div.dataset.json = JSON.stringify(info.items);
            container.appendChild(div);
        });
    }

    function renderHotspotList(data) {
        const container = document.getElementById('hotspot-list-container');
        container.innerHTML = '';
        data.forEach(spot => {
            const div = document.createElement('div');
            div.className = 'loc-card';
            div.style.borderLeftColor = '#27ae60';
            div.innerHTML = `
                <div class="loc-header" onclick="toggleHotspotDetail(this, '${spot.name}', ${spot.lat}, ${spot.lng})">
                    <div class="loc-name">ğŸŒŸ ${spot.name}</div>
                    <div class="loc-meta">${spot.desc.substring(0, 15)}...</div>
                </div>
                <div class="loc-details"></div>
            `;
            div.dataset.json = JSON.stringify(spot);
            container.appendChild(div);
        });
    }

    // === è¿‘æœŸç´€éŒ„ï¼šå±•é–‹è©³æƒ… ===
    async function toggleLocDetail(header, name, lat, lng) {
        const card = header.parentElement;
        const detailsDiv = card.querySelector('.loc-details');
        const isActive = card.classList.contains('active');
        
        document.querySelectorAll('.loc-card.active').forEach(el => el.classList.remove('active'));
        if(selectedMarker) map.removeLayer(selectedMarker);
        
        if(!isActive) {
            card.classList.add('active');
            map.flyTo([lat, lng], 15);
            setHighlightMarker(lat, lng); // 1. è¨­å®šåœ°æ¨™
            
            if(detailsDiv.innerHTML === '') {
                // 5. å¤©æ°£ä¿®å¾©
                let weatherHtml = '';
                try {
                    const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m&forecast_days=1`).then(r=>r.json());
                    const t = w.hourly.temperature_2m[new Date().getHours()];
                    weatherHtml = `<div class="weather-box">ğŸŒ¡ï¸ æ°£æº« ${t}Â°C</div>`;
                } catch(e) { weatherHtml = '<div class="weather-box">å¤©æ°£è¼‰å…¥å¤±æ•—</div>'; }

                const items = JSON.parse(card.dataset.json);
                let birdsHtml = '';
                items.forEach(b => {
                    // 4. çµ±ä¸€ç‰ˆé¢
                    birdsHtml += `
                        <div class="bird-record">
                            <img src="${b.wikiImg || 'https://via.placeholder.com/80'}" class="bird-thumb" referrerpolicy="no-referrer">
                            <div class="bird-info">
                                <div class="bird-header-line">
                                    <span class="bird-name-txt">${b.name}</span>
                                    <span class="bird-time-txt">${formatDate(b.date)}</span>
                                </div>
                                <div class="bird-desc-txt">${b.wikiDesc || 'æš«ç„¡ç°¡ä»‹'}</div>
                            </div>
                        </div>`;
                });
                detailsDiv.innerHTML = `${weatherHtml}<div class="loc-desc">è¿‘æœŸ eBird è§€æ¸¬ç´€éŒ„</div>${birdsHtml}`;
            }
            setTimeout(() => card.scrollIntoView({behavior: 'smooth', block: 'center'}), 300);
        }
    }

    // === ç†±é»ï¼šå±•é–‹è©³æƒ… ===
    async function toggleHotspotDetail(header, name, lat, lng) {
        const card = header.parentElement;
        const detailsDiv = card.querySelector('.loc-details');
        const isActive = card.classList.contains('active');
        
        document.querySelectorAll('.loc-card.active').forEach(el => el.classList.remove('active'));
        if(selectedMarker) map.removeLayer(selectedMarker);
        
        if(!isActive) {
            card.classList.add('active');
            map.flyTo([lat, lng], 14);
            setHighlightMarker(lat, lng);
            
            if(detailsDiv.innerHTML === '') {
                const spot = JSON.parse(card.dataset.json);
                
                // æ¯”å° 3km å…§çš„è¿‘æœŸç´€éŒ„
                const nearby = allRecentList.filter(b => getDistance(lat, lng, b.lat, b.lng) < 3.0);
                nearby.sort((a, b) => new Date(b.date) - new Date(a.date)); // 3. æ’åº

                let html = `<div class="loc-desc">${spot.desc}</div>`;

                // A. è¿‘æœŸå‡ºæ²’
                html += '<h5 style="margin:10px 0; border-bottom:2px solid #3498db; padding-bottom:4px;">ğŸ“… è¿‘æœŸå‡ºæ²’ (eBird)</h5>';
                const seenSpecies = new Set();
                
                if(nearby.length > 0) {
                     nearby.slice(0, 10).forEach(b => {
                        seenSpecies.add(b.name); // è¨˜éŒ„é³¥å
                        html += `
                        <div class="bird-record">
                            <img src="${b.wikiImg || 'https://via.placeholder.com/80'}" class="bird-thumb" referrerpolicy="no-referrer">
                            <div class="bird-info">
                                <div class="bird-header-line">
                                    <span class="bird-name-txt">${b.name}</span>
                                    <span class="bird-time-txt">${formatDate(b.date)}</span>
                                </div>
                                <div class="bird-desc-txt">${b.wikiDesc || 'æš«ç„¡ç°¡ä»‹'}</div>
                            </div>
                        </div>`;
                     });
                } else { 
                    html += '<div style="color:#888;font-size:0.9rem;padding:10px;">ç„¡è¿‘æœŸç´€éŒ„</div>'; 
                }

                // B. å¸¸é§é³¥ç¨® (éæ¿¾æ‰å·²å‡ºç¾åœ¨ä¸Šé¢çš„)
                html += '<h5 style="margin:20px 0 10px 0; border-bottom:2px solid #27ae60; padding-bottom:4px;">ğŸŒŸ å¸¸å¹´ä»£è¡¨é³¥ç¨®</h5>';
                if(spot.potential) {
                    spot.potential.forEach(b => {
                        // 4. å¦‚æœæ²’åœ¨è¿‘æœŸå‡ºç¾éï¼Œæ‰é¡¯ç¤ºåœ¨å¸¸é§å€
                        if (!seenSpecies.has(b.name)) {
                            html += `
                                <div class="bird-record" style="opacity:0.9;">
                                    <img src="${b.wikiImg || 'https://via.placeholder.com/80'}" class="bird-thumb" referrerpolicy="no-referrer">
                                    <div class="bird-info">
                                        <div class="bird-header-line">
                                            <span class="bird-name-txt">${b.name}</span>
                                            <span class="bird-time-txt" style="color:#27ae60;">å¸¸é§</span>
                                        </div>
                                        <div class="bird-desc-txt">${b.wikiDesc || 'æš«ç„¡ç°¡ä»‹'}</div>
                                    </div>
                                </div>`;
                        }
                    });
                }
                detailsDiv.innerHTML = html;
            }
            setTimeout(() => card.scrollIntoView({behavior: 'smooth', block: 'center'}), 300);
        }
    }

    // è·é›¢è¨ˆç®—
    function getDistance(lat1, lon1, lat2, lon2) {
        const p = 0.017453292519943295;
        const c = Math.cos;
        const a = 0.5 - c((lat2 - lat1) * p)/2 + c(lat1 * p) * c(lat2 * p) * (1 - c((lon2 - lon1) * p))/2;
        return 12742 * Math.asin(Math.sqrt(a));
    }

    function renderMarkers(data, isHotspot) {
        markers.clearLayers();
        data.forEach(item => {
            const lat = parseFloat(item.lat), lng = parseFloat(item.lng);
            if(isNaN(lat)) return;
            const icon = L.divIcon({
                className: 'custom-icon-container',
                html: getMarkerHtml(item.name, isHotspot),
                iconSize: [32, 32], iconAnchor: [16, 16]
            });
            const m = L.marker([lat, lng], { icon: icon, title: item.name });
            m.on('click', () => {
                if(isHotspot) {
                     const listHeader = document.querySelector(`.loc-header[onclick*="${item.name}"]`);
                     if(listHeader && currentTab === 'hotspot') listHeader.click();
                     else m.bindPopup(`<b>${item.name}</b>`).openPopup();
                } else {
                     const listHeader = document.querySelector(`#loc-${item.locName.replace(/\s+/g, '')} .loc-header`);
                     if(listHeader && currentTab === 'record') listHeader.click();
                     else m.bindPopup(`<b>${item.name}</b>`).openPopup();
                }
            });
            markers.addLayer(m);
        });
    }

    // --- 6. ç„¡é™æ²å‹•ç›¸é—œ ---
    function prepareBirdGrid(data) {
        const unique = {};
        data.forEach(b => { if(!unique[b.speciesCode]) unique[b.speciesCode] = b; });
        displayedBirds = Object.values(unique).sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
        loadIndex = 0;
        document.getElementById('bird-grid-container').innerHTML = '';
        loadMoreBirds();
    }

    function loadMoreBirds() {
        const container = document.getElementById('bird-grid-container');
        const end = Math.min(loadIndex + LOAD_STEP, displayedBirds.length);
        let html = '';
        for(let i=loadIndex; i<end; i++) {
            const b = displayedBirds[i];
            const img = b.wikiImg || 'https://via.placeholder.com/70';
            html += `
                <div class="bird-grid-item" data-code="${b.speciesCode}" onclick="filterBirds('${b.speciesCode}')">
                    <img src="${img}" class="bird-grid-img" referrerpolicy="no-referrer" loading="lazy">
                    <div class="bird-grid-name">${b.name}</div>
                </div>`;
        }
        container.insertAdjacentHTML('beforeend', html);
        loadIndex = end;
    }
    
    function searchBirdGrid(val) {
        const container = document.getElementById('bird-grid-container');
        container.innerHTML = '';
        const filtered = displayedBirds.filter(b => b.name.includes(val));
        
        let html = '';
        filtered.forEach(b => {
             const img = b.wikiImg || 'https://via.placeholder.com/70';
             html += `
                <div class="bird-grid-item" data-code="${b.speciesCode}" onclick="filterBirds('${b.speciesCode}')">
                    <img src="${img}" class="bird-grid-img" referrerpolicy="no-referrer">
                    <div class="bird-grid-name">${b.name}</div>
                </div>`;
        });
        container.innerHTML = html;
        if(val === '') { 
            loadIndex = 0;
            container.innerHTML = '';
            loadMoreBirds();
        }
    }

    function filterBirds(code) {
        currentFilterCode = code;
        if(currentTab !== 'record') document.querySelector('.tab:first-child').click();
        const filtered = allRecentList.filter(b => b.speciesCode === code);
        renderMarkers(filtered, false);
        renderLocationList(filtered);
        document.querySelectorAll('.bird-grid-item').forEach(el => el.classList.toggle('active', el.dataset.code === code));
        if (window.innerWidth <= 768) toggleMobileSearch();
    }

    function resetFilter() {
        currentFilterCode = null;
        renderMarkers(allRecentList, false);
        renderLocationList(allRecentList);
        document.querySelectorAll('.bird-grid-item').forEach(el => el.classList.remove('active'));
        if (window.innerWidth <= 768) toggleMobileSearch();
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('location-list-container').style.display = tab === 'record' ? 'block' : 'none';
        document.getElementById('hotspot-list-container').style.display = tab === 'hotspot' ? 'block' : 'none';
        
        if (tab === 'record') {
            const data = currentFilterCode ? allRecentList.filter(b=>b.speciesCode === currentFilterCode) : allRecentList;
            renderMarkers(data, false);
            renderLocationList(data);
        } else {
            renderMarkers(allHotspotsList, true);
            renderHotspotList(allHotspotsList);
        }
    }

    function toggleMobileSearch() { const el = document.getElementById('sidebar-right'); el.style.display = (el.style.display === 'flex') ? 'none' : 'flex'; }
    function resetMap() { map.setView([23.9738, 120.9820], 8); if(selectedMarker) map.removeLayer(selectedMarker); resetFilter(); }
    function locateUser() {
        navigator.geolocation.getCurrentPosition(p => {
            const {latitude, longitude} = p.coords;
            map.flyTo([latitude, longitude], 14);
            L.marker([latitude, longitude]).addTo(map).bindPopup("æ‚¨çš„ä½ç½®").openPopup();
        });
    }

    initMap();
</script>

</body>
</html>
