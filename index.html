<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£å¥½é³¥ - Taiwan Good Bird</title>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f0f2f5;}
        .container { display: flex; height: 100vh; position: relative; width: 100vw; }
        
        /* å·¦å´æ¬„ä½ */
        .sidebar-left { 
            width: 340px; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #ddd; 
            z-index: 20; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            height: 100%; 
            flex-shrink: 0; 
            position: relative; 
        }
        
        /* åœ°åœ–å€åŸŸ */
        #map { flex-grow: 1; height: 100%; z-index: 1; }
        
        /* å³å´æ¬„ä½ (æœå°‹) */
        .sidebar-right { 
            width: 340px; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #ddd; 
            z-index: 20; 
            flex-shrink: 0; 
            transition: transform 0.3s; 
            height: 100%; 
        }

        /* æ§åˆ¶æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .map-ctrl-btn { 
            position: absolute; top: 10px; z-index: 3000; 
            background: #2c3e50; color: white; padding: 8px 15px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; 
            border: 2px solid white; display: flex; align-items: center; white-space: nowrap; 
        }
        .map-ctrl-btn:hover { background: #34495e; transform: scale(1.05); }

        .home-btn { left: 10px; }
        .near-btn { left: 100px; background: #27ae60; } /* é™„è¿‘é³¥æ³æŒ‰éˆ• */

        /* æ‰‹æ©Ÿç‰ˆæœå°‹æŒ‰éˆ• (ç²¾ç°¡) */
        .mobile-search-toggle { 
            position: absolute; top: 10px; right: 10px; z-index: 3000; 
            background: #ffc107; color: #333; padding: 8px 12px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid white; 
            display: flex; align-items: center; font-size: 0.9em;
        }
        
        .mobile-search-close { display: none; background: #eee; border: none; padding: 10px; text-align: center; font-weight: bold; color: #555; cursor: pointer; border-bottom: 1px solid #ddd; }

        /* å…§å®¹æ¨£å¼ */
        .tab-group { display: flex; background: #f0f0f0; padding: 5px; gap: 5px; border-bottom: 1px solid #ddd; flex-shrink: 0;}
        .tab-btn { flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: #555; background: transparent; transition: 0.2s; }
        .tab-btn.active { background: #3498db; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .location-list { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; padding-bottom: 100px; }
        .loc-card { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; background: #fff; border-left: 5px solid #ddd;}
        .loc-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .loc-meta { font-size: 0.85em; color: #666; display: flex; justify-content: space-between; }
        .hotspot-group-title { font-weight:bold; margin: 15px 0 5px 0; color: #555; border-bottom: 2px solid #eee; padding: 5px 5px 5px 0;}
        
        /* è©³æƒ…é çµæ§‹ */
        .loc-detail-view { padding: 0; display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .detail-scroll-wrapper { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 150px; -webkit-overflow-scrolling: touch; }
        
        .weather-box { background: white; border: 1px solid #ddd; color: #333; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); flex-shrink: 0; }
        .weather-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        .weather-main-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;}
        .temp-big { font-size: 2.2em; font-weight: bold; color: #2c3e50; display:flex; align-items:center; gap:10px;}
        .weather-timeline-container { position: relative; margin-top: 15px; }
        .weather-color-bar { display: flex; height: 12px; width: 100%; border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .weather-color-segment { flex: 1; height: 100%; }
        input[type=range] { width: 100%; cursor: pointer; margin: 0; display: block; }
        .time-ticks { display: flex; justify-content: space-between; margin-top: 5px; color: #888; font-size: 0.75em; position: relative; padding: 0 2px; }
        .tick-mark { position: relative; text-align: center; width: 20px;}
        .tick-mark::before { content: '|'; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); color: #ccc; font-size: 0.8em; }
        .weather-time-label { font-size: 0.9em; text-align: center; margin-top: 10px; font-weight: bold; color: #3498db; background: #f0f8ff; padding: 5px; border-radius: 5px; }

        .bird-row { border-bottom: 1px solid #f0f0f0; transition: 0.3s; background: white; border-radius: 5px; margin-bottom: 5px; overflow: hidden;}
        .bird-header { display: flex; align-items: center; padding: 10px; cursor: pointer; }
        .bird-thumb-small { width: 45px; height: 45px; border-radius: 5px; object-fit: contain; background: #eee; border: 1px solid #ddd;}
        .bird-detail-content { display: none; padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; }
        .bird-detail-content.show { display: block; animation: slideDown 0.3s ease-out; }
        .large-bird-img { width: 100%; height: auto; max-height: 300px; border-radius: 8px; margin-top: 5px; object-fit: contain; background: #f0f0f0; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .search-header { background: #ffc107; padding: 15px; text-align: center; font-weight: bold; color: #333; flex-shrink: 0;}
        .bird-grid { flex-grow: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: 100px; gap: 8px; align-content: start;}
        .bird-grid-item { position: relative; width: 100%; height: 100%; border-radius: 6px; overflow: hidden; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background: #eee; display: flex; flex-direction: column; }
        .bird-grid-item img { width: 100%; height: 100%; object-fit: contain; background-color: #f0f0f0; transition: transform 0.3s; display: block; flex-grow: 1; }
        .bird-grid-item .bird-name-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; text-align: center; opacity: 0; transition: opacity 0.3s; padding: 5px; font-size: 0.85em; pointer-events: none; z-index: 2; background: rgba(0,0,0,0.6); }
        .bird-grid-item:hover .bird-name-overlay { opacity: 1; }
        .grid-badge { background: rgba(255, 193, 7, 0.9); color: #333; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; margin-top: 5px;}
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; font-weight: bold; color: #555; }
        .back-btn { margin: 10px 15px 0 15px; flex-shrink: 0; cursor: pointer; background: #e0f7fa; border: none; color: #006064; font-weight: bold; font-size: 1em; display: flex; align-items: center; padding: 10px; border-radius: 5px; width: auto; transition: 0.2s; }

        /* --- RWD éŸ¿æ‡‰å¼ App æ¨¡å¼ --- */
        @media (max-width: 768px) {
            .container { flex-direction: column; } 
            #map { width: 100%; height: 30vh; order: 1; flex-shrink: 0; }
            .sidebar-left { width: 100%; height: 70vh; order: 2; border-right: none; border-top: 1px solid #ddd; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
            .mobile-search-toggle { display: flex; } 
            .mobile-search-close { display: block; }

            .home-btn { padding: 8px 12px; }
            .near-btn { left: 75px; padding: 8px 12px; }

            .sidebar-right { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
            .sidebar-right.active { transform: translateX(0); }
            
            .bird-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .bird-grid-item img { height: 80px; }
            .bird-grid-item .bird-name-overlay { position: static; opacity: 1; background: white; color: #333; text-shadow: none; height: auto; padding: 5px 2px; justify-content: start; }
            .bird-grid-item .bird-name-overlay div:first-child { font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
        }
    </style>
</head>
<body>

<div id="loading">è¼‰å…¥æœ€æ–°é³¥æ³èˆ‡ç†±é»...</div>

<div class="map-ctrl-btn home-btn" onclick="resetApp()" title="å›åˆ°å…¨è¦½æ¨¡å¼">ğŸ </div>
<div class="map-ctrl-btn near-btn" onclick="locateAndFindBirds()" title="æœå°‹é™„è¿‘é³¥æ³">ğŸ“ é™„è¿‘é³¥æ³</div>
<div class="mobile-search-toggle" onclick="toggleMobileSearch(true)">ğŸ” é³¥ç¨®</div>

<div class="container">
    <div class="sidebar-left" id="sidebar-left-panel">
        <div class="tab-group">
            <button class="tab-btn" onclick="switchTab('record')">ç´€éŒ„åœ°é»</button>
            <button class="tab-btn active" onclick="switchTab('hotspot')">å°ç£è³é³¥ç†±é»</button>
        </div>
        <div id="location-list-container" class="location-list" style="display:none;"></div>
        <div id="hotspot-list-container" class="location-list"></div>
        
        <div id="location-detail-panel" class="loc-detail-view">
            <button class="back-btn" onclick="goBackToPreviousState()">â† è¿”å›åˆ—è¡¨</button>
            <div class="detail-scroll-wrapper">
                <h2 id="detail-loc-name" style="margin:10px 0 10px 0; font-size:1.3em;">åœ°é»åç¨±</h2>
                <div class="weather-box">
                    <div class="weather-header">
                        <div style="font-weight:bold; color:#666;">å¤©æ°£é å ± (48å°æ™‚)</div>
                        <div id="weather-desc" style="font-weight:bold; color:#333;">--</div>
                    </div>
                    <div class="weather-main-info">
                        <div class="temp-big"><span id="weather-icon-main">â˜ï¸</span><span id="weather-temp">--Â°C</span></div>
                        <div style="text-align:right; font-size:0.9em; color:#666;">
                            <div id="weather-wind">é¢¨é€Ÿ: --</div>
                            <div id="weather-rain-prob">é™é›¨æ©Ÿç‡: --%</div>
                        </div>
                    </div>
                    <div class="weather-timeline-container">
                        <div id="weather-color-bar" class="weather-color-bar"></div>
                        <input type="range" id="weather-slider" min="0" max="47" value="0" step="1">
                        <div class="time-ticks">
                            <span class="tick-mark">ç¾</span><span class="tick-mark">6h</span><span class="tick-mark">12h</span><span class="tick-mark">18h</span><span class="tick-mark">24h</span><span class="tick-mark">30h</span><span class="tick-mark">36h</span><span class="tick-mark">42h</span><span class="tick-mark">48h</span>
                        </div>
                    </div>
                    <div class="weather-time-label" id="weather-time-display">æ‹–å‹•æ»‘æ¡¿æŸ¥çœ‹é å ±</div>
                </div>
                <div id="detail-bird-list"></div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="sidebar-right" id="mobile-search-panel">
        <button class="mobile-search-close" onclick="toggleMobileSearch(false)">âœ• é—œé–‰æœå°‹</button>
        <div class="search-header">ğŸ¦ æœå°‹é³¥ç¨® (é»æ“Šåœ¨åœ°åœ–é¡¯ç¤º)</div>
        <div id="bird-search-list" class="bird-grid"></div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCU8mrNF6149G8L2fDAh1fsQIDQ25ZoGhw"></script>

<script>
    let map;
    let allBirdsData = [];
    let hotspotsDB = {};
    let markers = [];
    let markerCluster = null;
    let markerMap = {}; 
    let infoWindow;
    let weatherDataHourly = {}; 
    let currentMode = 'ALL'; 
    let previousMarkersData = []; 
    let currentTab = 'hotspot'; 
    let displayedBirds = [];
    let currentDisplayCount = 0;
    const BATCH_SIZE = 30;

    const BIRD_ICON_PATH = "M22.1,7c-0.8,0.4-1.6,0.6-2.5,0.7c0.9-0.6,1.6-1.4,2-2.5c-0.9,0.5-1.8,0.9-2.8,1.1c-0.8-0.9-2-1.4-3.2-1.4 c-2.4,0-4.4,2-4.4,4.4c0,0.3,0,0.7,0.1,1c-3.7-0.2-6.9-1.9-9.1-4.6c-0.4,0.7-0.6,1.5-0.6,2.2c0,1.5,0.8,2.9,1.9,3.7 c-0.7,0-1.4-0.2-2-0.6c0,0,0,0,0,0.1c0,2.1,1.5,3.9,3.5,4.3c-0.4,0.1-0.8,0.2-1.2,0.2c-0.3,0-0.6,0-0.9-0.1 c0.6,1.8,2.2,3,4.2,3.1c-1.5,1.2-3.4,1.9-5.4,1.9c-0.4,0-0.7,0-1.1-0.1c2,1.3,4.3,2,6.8,2c8.1,0,12.6-6.7,12.6-12.6 c0-0.2,0-0.4,0-0.6C20.7,8.6,21.5,7.9,22.1,7z";
    const COUNTY_COLORS = { "åŸºéš†å¸‚": "#2c3e50", "å°åŒ—å¸‚": "#e74c3c", "æ–°åŒ—å¸‚": "#d35400", "æ¡ƒåœ’å¸‚": "#f1c40f", "æ–°ç«¹ç¸£å¸‚": "#27ae60", "è‹—æ —ç¸£": "#16a085", "å°ä¸­å¸‚": "#2980b9", "å½°åŒ–ç¸£": "#8e44ad", "å—æŠ•ç¸£": "#2c3e50", "é›²æ—ç¸£": "#e67e22", "å˜‰ç¾©ç¸£å¸‚": "#c0392b", "å°å—å¸‚": "#f39c12", "é«˜é›„å¸‚": "#2ecc71", "å±æ±ç¸£": "#3498db", "å®œè˜­ç¸£": "#1abc9c", "èŠ±è“®ç¸£": "#9b59b6", "å°æ±ç¸£": "#e74c3c", "é›¢å³¶": "#7f8c8d" };
    const DEFAULT_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjOTk5Ij48cGF0aCBkPSJNNDk2IDM4NEgxMjhWODBjMC04LjgtNy4yLTE2LTE2LTE2SgwYy04LjggMC0xNiA3LjItMTYgMTZ2MzJjMCA4LjggNy4yIDE2IDE2IDE2aDQ4MGM4LjggMCAxNi03LjIgMTYtMTZ2LTMyYzAtOC44LTcuMi0xNi0xNi0xNnptMC0xNjBoLTgwYy04LjggMC0xNiA3LjItMTYgMTZ2MzJjMCA4LjggNy4yIDE2IDE2IDE2aDgwYzguOCAwIDE2LTcuMiAxNi0xNnYtMzJjMC04LjgtNy4yLTE2LTE2LTE2em0wLTE2MGgtODBjLTguOCAwLTE2IDcuMi0xNiAxNnYzMmMwIDguOCA3LjIzIDE2IDE2IDE2aDgwYzguOCAwIDE2LTcuMiAxNi0xNlY4MGMwLTguOC03LjItMTYtMTYtMTZ6Ii8+PC9zdmc+";

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.973875, lng: 120.982024 },
            zoom: 8,
            mapTypeControl: false,
            streetViewControl: false
        });
        infoWindow = new google.maps.InfoWindow();
        fetchBirds();
        document.getElementById('weather-slider').addEventListener('input', function() { updateWeatherDisplay(this.value); });
        const gridContainer = document.getElementById('bird-search-list');
        gridContainer.addEventListener('scroll', () => {
            if (gridContainer.scrollTop + gridContainer.clientHeight >= gridContainer.scrollHeight - 100) loadMoreBirds();
        });
    }

    // --- æ–°å¢ï¼šé™„è¿‘é³¥æ³å®šä½åŠŸèƒ½ ---
    function locateAndFindBirds() {
        if (!navigator.geolocation) {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½");
            return;
        }
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading').innerText = "æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...";

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const userLoc = { lat: userLat, lng: userLng };

                map.setCenter(userLoc);
                map.setZoom(13);
                
                // éæ¿¾æ–¹åœ“ 10km å…§çš„è³‡æ–™ (ç´„ 0.09 åº¦)
                const nearbyBirds = allBirdsData.filter(b => {
                    const dist = Math.sqrt(Math.pow(b.lat - userLat, 2) + Math.pow(b.lng - userLng, 2));
                    return dist < 0.09; 
                });

                switchTab('record');
                renderMarkers(nearbyBirds, true);
                renderLocationList(nearbyBirds);
                
                document.getElementById('loading').style.display = 'none';
                if(nearbyBirds.length === 0) alert("åŠå¾‘ 10 å…¬é‡Œå…§è¿‘æœŸç„¡ eBird ç´€éŒ„");
            },
            () => {
                document.getElementById('loading').style.display = 'none';
                alert("ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š");
            }
        );
    }

    function toggleMobileSearch(show) {
        const panel = document.getElementById('mobile-search-panel');
        if (show) panel.classList.add('active');
        else panel.classList.remove('active');
    }

    async function fetchBirds() {
        try {
            const response = await fetch('./static/birds_data.json');
            const rawData = await response.json();
            if (rawData.hotspots) {
                allBirdsData = rawData.recent;
                hotspotsDB = rawData.hotspots;
            } else {
                allBirdsData = rawData;
                hotspotsDB = {}; 
            }
            document.getElementById('loading').style.display = 'none';
            renderHotSpotsList(); 
            switchTab('hotspot');
            renderBirdSearchList(allBirdsData);
        } catch (error) {
            document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™ä¾†æº";
        }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if (infoWindow) infoWindow.close();
        if (tab === 'record') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('location-list-container').style.display = 'block';
            document.getElementById('hotspot-list-container').style.display = 'none';
            renderLocationList(allBirdsData);
            renderMarkers(allBirdsData);
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('location-list-container').style.display = 'none';
            document.getElementById('hotspot-list-container').style.display = 'block';
            renderHotSpotMapMarkers();
        }
        document.getElementById('location-detail-panel').style.display = 'none';
    }

    function renderHotSpotMapMarkers() {
        if (markerCluster) markerCluster.clearMarkers();
        markers.forEach(m => m.setMap(null));
        markers = [];
        for (const [city, spots] of Object.entries(hotspotsDB)) {
            const cityColor = COUNTY_COLORS[city] || "#2980b9"; 
            spots.forEach(spot => {
                const marker = new google.maps.Marker({
                    position: { lat: spot.lat, lng: spot.lng },
                    title: spot.name,
                    icon: { path: BIRD_ICON_PATH, scale: 1.2, fillColor: cityColor, fillOpacity: 1, strokeWeight: 1, strokeColor: "white", anchor: new google.maps.Point(12, 12) }
                });
                marker.addListener("click", () => openDirectHotspot(spot.name, spot.lat, spot.lng, spot.potential));
                markers.push(marker);
            });
        }
        markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
    }

    function renderHotSpotsList() {
        const container = document.getElementById('hotspot-list-container');
        container.innerHTML = '';
        for (const [city, spots] of Object.entries(hotspotsDB)) {
            const titleDiv = document.createElement('div');
            titleDiv.className = 'hotspot-group-title';
            titleDiv.style.borderLeft = `5px solid ${COUNTY_COLORS[city] || "#ddd"}`;
            titleDiv.innerText = city;
            container.appendChild(titleDiv);
            spots.forEach(spot => {
                const div = document.createElement('div');
                div.className = 'loc-card';
                div.innerHTML = `<div class="loc-name">${spot.name}</div><div style="font-size:0.85em; color:#666;">${spot.desc}</div>`;
                div.onclick = () => openDirectHotspot(spot.name, spot.lat, spot.lng, spot.potential);
                container.appendChild(div);
            });
        }
    }

    function openDirectHotspot(name, lat, lng, potentialBirds) {
        map.setCenter({ lat: lat, lng: lng });
        map.setZoom(16);
        if (window.selectedMarker) window.selectedMarker.setMap(null);
        window.selectedMarker = new google.maps.Marker({ map: map, position: { lat: lat, lng: lng }, animation: google.maps.Animation.DROP });
        infoWindow.setContent(`<div style="padding:5px; font-weight:bold;">${name}</div>`);
        infoWindow.open(map, window.selectedMarker);
        openLocationDetail(name, lat, lng, true, potentialBirds);
    }

    function renderMarkers(birds, isHighlight = false) {
        if (markerCluster) markerCluster.clearMarkers();
        markers.forEach(m => m.setMap(null));
        markers = [];
        const locationGroups = {};
        birds.forEach(bird => {
            const key = `${bird.lat},${bird.lng}`;
            if (!locationGroups[key]) locationGroups[key] = { lat: bird.lat, lng: bird.lng, locName: bird.locName, speciesSet: new Set() };
            locationGroups[key].speciesSet.add(bird.name);
        });
        Object.values(locationGroups).forEach(group => {
            const marker = new google.maps.Marker({
                position: { lat: group.lat, lng: group.lng },
                map: map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 10, fillColor: isHighlight ? "#d35400" : "#FF5722", fillOpacity: 0.9, strokeWeight: 2, strokeColor: "white" },
                label: { text: group.speciesSet.size.toString(), color: "white", fontSize: "12px", fontWeight: "bold" }
            });
            marker.addListener("click", () => {
                infoWindow.setContent(`<div style='padding:5px; font-weight:bold;'>${group.locName}</div>`);
                infoWindow.open(map, marker);
                openLocationDetail(group.locName, group.lat, group.lng);
            });
            markers.push(marker);
        });
    }

    function renderLocationList(birds) {
        const container = document.getElementById('location-list-container');
        container.innerHTML = '';
        const locGroups = {};
        birds.forEach(bird => {
            if (!locGroups[bird.locName]) locGroups[bird.locName] = { lat: bird.lat, lng: bird.lng, birds: [] };
            if (!locGroups[bird.locName].birds.some(b => b.name === bird.name)) locGroups[bird.locName].birds.push(bird);
        });
        Object.entries(locGroups).sort((a, b) => b[1].birds.length - a[1].birds.length).forEach(([locName, data]) => {
            const div = document.createElement('div');
            div.className = 'loc-card';
            div.innerHTML = `<div class="loc-name">${locName}</div><div class="loc-meta"><span>${data.birds.length} ç¨®é³¥é¡</span><span style="color:#3498db;">è©³æƒ… â†’</span></div>`;
            div.onclick = () => { map.setCenter({ lat: data.lat, lng: data.lng }); map.setZoom(15); openLocationDetail(locName, data.lat, data.lng); };
            container.appendChild(div);
        });
    }

    function openLocationDetail(locName, lat, lng, isHot = false, potential = []) {
        document.getElementById('location-list-container').style.display = 'none';
        document.getElementById('hotspot-list-container').style.display = 'none';
        document.getElementById('location-detail-panel').style.display = 'flex';
        document.getElementById('detail-loc-name').innerText = locName;
        fetchWeatherHourly(lat, lng);
        const birdListDiv = document.getElementById('detail-bird-list');
        birdListDiv.innerHTML = '';
        const birdsHere = isHot ? allBirdsData.filter(b => Math.abs(b.lat - lat) < 0.01 && Math.abs(b.lng - lng) < 0.01) : allBirdsData.filter(b => b.locName === locName);
        renderAccordionBirdList(birdsHere, birdListDiv);
    }

    function goBackToPreviousState() {
        document.getElementById('location-detail-panel').style.display = 'none';
        if (currentTab === 'record') document.getElementById('location-list-container').style.display = 'block';
        else document.getElementById('hotspot-list-container').style.display = 'block';
    }

    function renderAccordionBirdList(birds, container) {
        const seen = new Set();
        birds.forEach((bird, idx) => {
            if (seen.has(bird.name)) return;
            seen.add(bird.name);
            const row = document.createElement('div');
            row.className = 'bird-row';
            const contentId = `c-${idx}-${Math.random().toString(36).substr(2, 5)}`;
            row.innerHTML = `
                <div class="bird-header" onclick="toggleBirdDetail('${contentId}')">
                    <img class="bird-thumb-small" src="${bird.wikiImg || DEFAULT_IMG}">
                    <div style="flex-grow:1; margin-left:10px;">
                        <div style="font-weight:bold;">${bird.name}</div>
                        <div style="font-size:0.8em; color:#666;">${bird.sciName}</div>
                    </div>
                    <div style="color:#aaa;">â–¼</div>
                </div>
                <div id="${contentId}" class="bird-detail-content">
                    <img class="large-bird-img" src="${bird.wikiImg || DEFAULT_IMG}">
                    <div class="intro-text">${bird.wikiDesc || "æš«ç„¡ä»‹ç´¹"}</div>
                </div>`;
            container.appendChild(row);
        });
    }

    function toggleBirdDetail(id) {
        const el = document.getElementById(id);
        const isShow = el.classList.contains('show');
        document.querySelectorAll('.bird-detail-content').forEach(c => c.classList.remove('show'));
        if (!isShow) el.classList.add('show');
    }

    async function fetchWeatherHourly(lat, lng) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,weathercode,windspeed_10m,precipitation_probability&forecast_days=2&timezone=auto`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            weatherDataHourly = data.hourly;
            const bar = document.getElementById('weather-color-bar');
            bar.innerHTML = '';
            for (let i = 0; i < 48; i++) {
                const seg = document.createElement('div');
                seg.className = 'weather-color-segment';
                seg.style.backgroundColor = (weatherDataHourly.weathercode[i] === 0) ? '#ffa726' : '#b0bec5';
                bar.appendChild(seg);
            }
            updateWeatherDisplay(0);
        } catch (e) {}
    }

    function updateWeatherDisplay(i) {
        if (!weatherDataHourly.time) return;
        const temp = weatherDataHourly.temperature_2m[i];
        document.getElementById('weather-temp').innerText = `${temp}Â°C`;
        document.getElementById('weather-time-display').innerText = `é å ±æ™‚é–“: ${new Date(weatherDataHourly.time[i]).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit'})}`;
    }

    function renderBirdSearchList(birds) {
        const container = document.getElementById('bird-search-list');
        const birdStats = {};
        birds.forEach(b => {
            if (!birdStats[b.name]) birdStats[b.name] = { data: b, count: 0 };
            birdStats[b.name].count++;
        });
        displayedBirds = Object.values(birdStats).sort((a,b) => b.count - a.count);
        loadMoreBirds();
    }

    function loadMoreBirds() {
        const container = document.getElementById('bird-search-list');
        const nextBatch = displayedBirds.slice(currentDisplayCount, currentDisplayCount + BATCH_SIZE);
        nextBatch.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bird-grid-item';
            div.innerHTML = `<img src="${item.data.wikiImg || DEFAULT_IMG}"><div class="bird-name-overlay"><div>${item.data.name}</div><div class="grid-badge">${item.count} ç´€éŒ„</div></div>`;
            div.onclick = () => {
                const filtered = allBirdsData.filter(b => b.name === item.data.name);
                switchTab('record');
                renderMarkers(filtered, true);
                if (window.innerWidth <= 768) toggleMobileSearch(false);
                const bounds = new google.maps.LatLngBounds();
                filtered.forEach(b => bounds.extend({lat:b.lat, lng:b.lng}));
                map.fitBounds(bounds);
            };
            container.appendChild(div);
        });
        currentDisplayCount += nextBatch.length;
    }

    function resetApp() {
        map.setZoom(8);
        map.setCenter({ lat: 23.973875, lng: 120.982024 });
        switchTab(currentTab);
    }

    window.onload = initMap;
</script>
</body>
</html>
