<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£å¥½é³¥ - Taiwan Good Bird</title>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f0f2f5;}
        .container { display: flex; height: 100vh; position: relative; width: 100vw; }
        
        .sidebar-left { 
            width: 340px; background: white; display: flex; flex-direction: column; 
            border-right: 1px solid #ddd; z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            height: 100%; flex-shrink: 0; position: relative; 
        }
        
        #map { flex-grow: 1; height: 100%; z-index: 1; }
        
        .sidebar-right { 
            width: 340px; background: white; display: flex; flex-direction: column; 
            border-left: 1px solid #ddd; z-index: 20; flex-shrink: 0; 
            transition: transform 0.3s; height: 100%; 
        }

        .map-ctrl-btn { 
            position: absolute; top: 10px; z-index: 3000; 
            background: #2c3e50; color: white; padding: 8px 15px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; 
            border: 2px solid white; display: flex; align-items: center; white-space: nowrap; 
        }
        .map-ctrl-btn:hover { background: #34495e; transform: scale(1.05); }

        .home-btn { left: 350px; }
        .near-btn { left: 410px; background: #27ae60; } 

        .mobile-search-toggle { 
            display: none; position: absolute; top: 10px; right: 10px; z-index: 3000; 
            background: #ffc107; color: #333; padding: 8px 12px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid white; 
            align-items: center; font-size: 0.9em;
        }
        .mobile-search-close { display: none; background: #eee; border: none; padding: 10px; text-align: center; font-weight: bold; color: #555; cursor: pointer; border-bottom: 1px solid #ddd; }

        .tab-group { display: flex; background: #f0f0f0; padding: 5px; gap: 5px; border-bottom: 1px solid #ddd; flex-shrink: 0;}
        .tab-btn { flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: #555; background: transparent; transition: 0.2s; }
        .tab-btn.active { background: #3498db; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* æ–°å¢ï¼šæœ€å¾Œæ›´æ–°æ™‚é–“ */
        #last-update { font-size: 0.75em; color: #888; text-align: center; padding: 5px; background: #fafafa; border-bottom: 1px solid #eee; }

        .location-list { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; padding-bottom: 100px; }
        .loc-card { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; background: #fff; border-left: 5px solid #ddd;}
        .loc-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .hotspot-group-title { font-weight:bold; margin: 15px 0 5px 0; color: #555; border-bottom: 2px solid #eee; padding: 5px 5px 5px 0;}
        
        .loc-detail-view { padding: 0; display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .detail-scroll-wrapper { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 150px; -webkit-overflow-scrolling: touch; }
        .back-btn { margin: 10px 15px 0 15px; flex-shrink: 0; cursor: pointer; background: #e0f7fa; border: none; color: #006064; font-weight: bold; padding: 10px; border-radius: 5px; }

        .weather-box { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .temp-big { font-size: 2.2em; font-weight: bold; color: #2c3e50; display:flex; align-items:center; gap:10px;}
        .weather-color-bar { display: flex; height: 12px; width: 100%; border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .weather-color-segment { flex: 1; height: 100%; }

        .bird-row { border-bottom: 1px solid #f0f0f0; background: white; border-radius: 5px; margin-bottom: 5px; overflow: hidden;}
        .bird-header { display: flex; align-items: center; padding: 10px; cursor: pointer; }
        .bird-thumb-small { width: 45px; height: 45px; border-radius: 5px; object-fit: contain; background: #eee; border: 1px solid #ddd;}
        .bird-detail-content { display: none; padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; }
        .bird-detail-content.show { display: block; }
        .large-bird-img { width: 100%; height: auto; max-height: 300px; border-radius: 8px; object-fit: contain; background: #f0f0f0; }

        .search-header { background: #ffc107; padding: 15px; text-align: center; font-weight: bold; color: #333; }
        .bird-grid { flex-grow: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start;}
        .bird-grid-item { position: relative; border-radius: 6px; overflow: hidden; cursor: pointer; background: #eee; height: 100px;}
        .bird-grid-item img { width: 100%; height: 100%; object-fit: contain; }
        .bird-name-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; font-size: 0.85em; text-align: center; }
        .bird-grid-item:hover .bird-name-overlay { opacity: 1; }
        .grid-badge { background: rgba(255, 193, 7, 0.9); color: #333; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; margin-top: 5px;}

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; font-weight: bold; }

        @media (max-width: 768px) {
            .container { flex-direction: column; } 
            #map { width: 100%; height: 30vh; order: 1; }
            .sidebar-left { width: 100%; height: 70vh; order: 2; border-right: none; border-top: 1px solid #ddd; }
            .home-btn { left: 10px; padding: 8px 12px; }
            .near-btn { left: 75px; padding: 8px 12px; }
            .mobile-search-toggle { display: flex; }
            .mobile-search-close { display: block; }
            .sidebar-right { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; transform: translateX(100%); transition: transform 0.3s; }
            .sidebar-right.active { transform: translateX(0); }
        }
    </style>
</head>
<body>

<div id="loading">è¼‰å…¥æœ€æ–°é³¥æ³èˆ‡ç†±é»...</div>

<div class="map-ctrl-btn home-btn" onclick="resetApp()" title="å›åˆ°å…¨è¦½æ¨¡å¼">ğŸ </div>
<div class="map-ctrl-btn near-btn" onclick="locateAndFindBirds()" title="æœå°‹é™„è¿‘é³¥æ³">ğŸ“ é™„è¿‘é³¥æ³</div>
<div class="mobile-search-toggle" onclick="toggleMobileSearch(true)">ğŸ” é³¥ç¨®</div>

<div class="container">
    <div class="sidebar-left">
        <div class="tab-group">
            <button class="tab-btn" onclick="switchTab('record')">ç´€éŒ„åœ°é»</button>
            <button class="tab-btn active" onclick="switchTab('hotspot')">å°ç£è³é³¥ç†±é»</button>
        </div>
        <div id="last-update">è³‡æ–™æ›´æ–°ä¸­...</div>

        <div id="location-list-container" class="location-list" style="display:none;"></div>
        <div id="hotspot-list-container" class="location-list"></div>
        
        <div id="location-detail-panel" class="loc-detail-view">
            <button class="back-btn" onclick="goBackToPreviousState()">â† è¿”å›åˆ—è¡¨</button>
            <div class="detail-scroll-wrapper">
                <h2 id="detail-loc-name" style="margin:10px 0;">åœ°é»åç¨±</h2>
                <div class="weather-box">
                    <div id="weather-desc" style="font-weight:bold; color:#333; margin-bottom:5px;">--</div>
                    <div class="temp-big"><span id="weather-icon-main">â˜ï¸</span><span id="weather-temp">--Â°C</span></div>
                    <div class="weather-color-bar" id="weather-color-bar"></div>
                    <input type="range" id="weather-slider" min="0" max="47" value="0" style="width:100%;">
                    <div id="weather-time-display" style="text-align:center; font-size:0.85em; margin-top:5px; color:#3498db;">æ‹–å‹•æ»‘æ¡¿æŸ¥çœ‹é å ±</div>
                </div>
                <div id="detail-bird-list"></div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="sidebar-right" id="mobile-search-panel">
        <button class="mobile-search-close" onclick="toggleMobileSearch(false)">âœ• é—œé–‰æœå°‹</button>
        <div class="search-header">ğŸ¦ æœå°‹é³¥ç¨®</div>
        <div id="bird-search-list" class="bird-grid"></div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCU8mrNF6149G8L2fDAh1fsQIDQ25ZoGhw"></script>

<script>
    let map, allBirdsData = [], hotspotsDB = {}, markers = [], markerCluster = null, infoWindow, weatherDataHourly = {}; 
    let currentTab = 'hotspot', displayedBirds = [], currentDisplayCount = 0;
    const BATCH_SIZE = 30;
    const BIRD_ICON_PATH = "M22.1,7c-0.8,0.4-1.6,0.6-2.5,0.7c0.9-0.6,1.6-1.4,2-2.5c-0.9,0.5-1.8,0.9-2.8,1.1c-0.8-0.9-2-1.4-3.2-1.4 c-2.4,0-4.4,2-4.4,4.4c0,0.3,0,0.7,0.1,1c-3.7-0.2-6.9-1.9-9.1-4.6c-0.4,0.7-0.6,1.5-0.6,2.2c0,1.5,0.8,2.9,1.9,3.7 c-0.7,0-1.4-0.2-2-0.6c0,0,0,0,0,0.1c0,2.1,1.5,3.9,3.5,4.3c-0.4,0.1-0.8,0.2-1.2,0.2c-0.3,0-0.6,0-0.9-0.1 c0.6,1.8,2.2,3,4.2,3.1c-1.5,1.2-3.4,1.9-5.4,1.9c-0.4,0-0.7,0-1.1-0.1c2,1.3,4.3,2,6.8,2c8.1,0,12.6-6.7,12.6-12.6 c0-0.2,0-0.4,0-0.6C20.7,8.6,21.5,7.9,22.1,7z";
    const COUNTY_COLORS = { "åŸºéš†å¸‚": "#2c3e50", "å°åŒ—å¸‚": "#e74c3c", "æ–°åŒ—å¸‚": "#d35400", "æ¡ƒåœ’å¸‚": "#f1c40f", "æ–°ç«¹ç¸£å¸‚": "#27ae60", "è‹—æ —ç¸£": "#16a085", "å°ä¸­å¸‚": "#2980b9", "å½°åŒ–ç¸£": "#8e44ad", "å—æŠ•ç¸£": "#2c3e50", "é›²æ—ç¸£": "#e67e22", "å˜‰ç¾©ç¸£å¸‚": "#c0392b", "å°å—å¸‚": "#f39c12", "é«˜é›„å¸‚": "#2ecc71", "å±æ±ç¸£": "#3498db", "å®œè˜­ç¸£": "#1abc9c", "èŠ±è“®ç¸£": "#9b59b6", "å°æ±ç¸£": "#e74c3c", "é›¢å³¶": "#7f8c8d" };
    const DEFAULT_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjOTk5Ij48cGF0aCBkPSJNNDk2IDM4NEgxMjhWODBjMC04LjgtNy4yLTE2LTE2LTE2SDgwYy04LjggMC0xNiA3LjItMTYgMTZ2MzJjMCA4LjggNy4yIDE2IDE2IDE2aDQ4MGM4LjggMCAxNi03LjIgMTYtMTZ2LTMyYzAtOC44LTcuMi0xNi0xNi0xNnptMC0xNjBoLTgwYy04LjggMC0xNiA3LjItMTYgMTZ2MzJjMCA4LjggNy4yIDE2IDE2IDE2aDgwYzguOCAwIDE2LTcuMiAxNi0xNnYtMzJjMC04LjgtNy4yLTE2LTE2LTE2em0wLTE2MGgtODBjLTguOCAwLTE2IDcuMi0xNiAxNnYzMmMwIDguOCA3LjIzIDE2IDE2IDE2aDgwYzguOCAwIDE2LTcuMiAxNi0xNlY4MGMwLTguOC03LjItMTYtMTYtMTZ6Ii8+PC9zdmc+";

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), { center: { lat: 23.97, lng: 120.98 }, zoom: 8, mapTypeControl: false, streetViewControl: false });
        infoWindow = new google.maps.InfoWindow();
        fetchBirds();
        document.getElementById('weather-slider').addEventListener('input', function() { updateWeatherDisplay(this.value); });
        
        document.getElementById('bird-search-list').addEventListener('scroll', function() {
            if (this.scrollTop + this.clientHeight >= this.scrollHeight - 200) {
                loadMoreBirds();
            }
        });
    }

    function locateAndFindBirds() {
        if (!navigator.geolocation) return;
        document.getElementById('loading').style.display = 'flex';
        navigator.geolocation.getCurrentPosition(pos => {
            const uLat = pos.coords.latitude, uLng = pos.coords.longitude;
            map.setCenter({ lat: uLat, lng: uLng }); map.setZoom(13);
            const nearby = allBirdsData.filter(b => Math.sqrt(Math.pow(b.lat-uLat,2)+Math.pow(b.lng-uLng,2)) < 0.09);
            switchTab('record'); renderMarkers(nearby, true); renderLocationList(nearby);
            document.getElementById('loading').style.display = 'none';
        }, () => { document.getElementById('loading').style.display = 'none'; alert("å®šä½å¤±æ•—"); });
    }

    async function fetchBirds() {
        try {
            const res = await fetch('./static/birds_data.json');
            const data = await res.json();
            
            // è™•ç†æ–°çš„ JSON çµæ§‹ä¸¦æ›´æ–°æ™‚é–“
            if (data.update_at) {
                allBirdsData = data.recent;
                hotspotsDB = data.hotspots;
                document.getElementById('last-update').innerText = "æœ€å¾Œæ›´æ–°æ™‚é–“: " + data.update_at;
            } else {
                allBirdsData = data.recent || data;
                hotspotsDB = data.hotspots || {};
                document.getElementById('last-update').innerText = "";
            }

            document.getElementById('loading').style.display = 'none';
            renderHotSpotsList(); switchTab('hotspot'); renderBirdSearchList(allBirdsData);
        } catch (e) { document.getElementById('loading').innerText = "è¼‰å…¥å¤±æ•—"; }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(tab==='record'?'ç´€éŒ„':'ç†±é»')));
        document.getElementById('location-list-container').style.display = tab==='record'?'block':'none';
        document.getElementById('hotspot-list-container').style.display = tab==='hotspot'?'block':'none';
        document.getElementById('location-detail-panel').style.display = 'none';
        if(tab==='record') { renderLocationList(allBirdsData); renderMarkers(allBirdsData); } else renderHotSpotMapMarkers();
    }

    function renderHotSpotMapMarkers() {
        if (markerCluster) {
            markerCluster.clearMarkers();
            markerCluster = null;
        }
        markers.forEach(m => m.setMap(null)); markers = [];
        for (const [city, spots] of Object.entries(hotspotsDB)) {
            spots.forEach(s => {
                const m = new google.maps.Marker({ position: {lat:s.lat, lng:s.lng}, icon: {path: BIRD_ICON_PATH, scale: 1.2, fillColor: COUNTY_COLORS[city]||"#2980b9", fillOpacity: 1, strokeWeight: 1, strokeColor: "white", anchor: new google.maps.Point(12, 12)} });
                m.addListener("click", () => openLocationDetail(s.name, s.lat, s.lng, true));
                markers.push(m);
            });
        }
        markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
    }

    function renderHotSpotsList() {
        const container = document.getElementById('hotspot-list-container');
        container.innerHTML = '';
        for (const [city, spots] of Object.entries(hotspotsDB)) {
            const t = document.createElement('div'); t.className = 'hotspot-group-title'; t.style.borderLeft = `5px solid ${COUNTY_COLORS[city]}`; t.innerText = city; container.appendChild(t);
            spots.forEach(s => {
                const d = document.createElement('div'); d.className = 'loc-card'; d.innerHTML = `<div class="loc-name">${s.name}</div><div style="font-size:0.85em;color:#666;">${s.desc}</div>`;
                d.onclick = () => { map.setCenter({lat:s.lat, lng:s.lng}); map.setZoom(16); openLocationDetail(s.name, s.lat, s.lng, true); };
                container.appendChild(d);
            });
        }
    }

    function renderMarkers(birds, isHighlight = false) {
        if (markerCluster) {
            markerCluster.clearMarkers();
            markerCluster = null;
        }
        markers.forEach(m => m.setMap(null)); 
        markers = [];

        const locs = {};
        birds.forEach(b => { 
            const k = `${b.lat},${b.lng}`; 
            if(!locs[k]) locs[k] = {lat:b.lat, lng:b.lng, name:b.locName, count:0}; 
            locs[k].count++; 
        });

        Object.values(locs).forEach(g => {
            const m = new google.maps.Marker({ 
                position: {lat:g.lat, lng:g.lng}, 
                icon: {
                    path: google.maps.SymbolPath.CIRCLE, 
                    scale: 10, 
                    fillColor: isHighlight ? "#d35400" : "#FF5722", 
                    fillOpacity: 0.9, 
                    strokeWeight: 2, 
                    strokeColor: "white"
                }, 
                label: {
                    text: g.count.toString(), 
                    color: "white", 
                    fontSize: "12px"
                } 
            });
            m.addListener("click", () => openLocationDetail(g.name, g.lat, g.lng));
            markers.push(m);
        });

        markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
    }

    function renderLocationList(birds) {
        const container = document.getElementById('location-list-container'); container.innerHTML = '';
        const grp = {}; birds.forEach(b => { if(!grp[b.locName]) grp[b.locName]={lat:b.lat, lng:b.lng, s:new Set()}; grp[b.locName].s.add(b.name); });
        Object.entries(grp).sort((a,b)=>b[1].s.size-a[1].s.size).forEach(([n, d]) => {
            const v = document.createElement('div'); v.className = 'loc-card'; v.innerHTML = `<div class="loc-name">${n}</div><div style="font-size:0.85em;color:#888;">${d.s.size} ç¨®é³¥é¡ç´€éŒ„</div>`;
            v.onclick = () => { map.setCenter({lat:d.lat, lng:d.lng}); map.setZoom(15); openLocationDetail(n, d.lat, d.lng); };
            container.appendChild(v);
        });
    }

    // ä¿®æ­£ï¼šç„¡è«–é»æ“Šå“ªç¨®æ¨™è¨˜ï¼Œéƒ½æœƒå˜—è©¦å»å°‹æ‰¾è©²åœ°é»æ˜¯å¦ç‚ºç†±é»ï¼Œä¸¦é¡¯ç¤ºå°æ‡‰ä»‹ç´¹
    function openLocationDetail(name, lat, lng, isHot = false) {
        document.getElementById('location-list-container').style.display = 'none';
        document.getElementById('hotspot-list-container').style.display = 'none';
        document.getElementById('location-detail-panel').style.display = 'flex';
        document.getElementById('detail-loc-name').innerText = name;
        fetchWeatherHourly(lat, lng);

        const birdListDiv = document.getElementById('detail-bird-list');
        birdListDiv.innerHTML = '';

        const recentBirds = allBirdsData.filter(b => b.locName === name || (Math.abs(b.lat - lat) < 0.005 && Math.abs(b.lng - lng) < 0.005));
        
        // ä¿®æ­£ï¼šå¼·åˆ¶å°‹æ‰¾æ½›åœ¨é³¥ç¨® (ä»‹ç´¹)ï¼Œå³ä½¿æ˜¯å¾ orange point é»é€²ä¾†çš„
        let potentialBirds = [];
        let locationDesc = "";
        
        for (let city in hotspotsDB) {
            let found = hotspotsDB[city].find(s => s.name === name);
            if (found) { 
                if(found.potential) potentialBirds = found.potential;
                if(found.desc) locationDesc = found.desc;
                break; 
            }
        }

        // å¦‚æœæœ‰ç†±é»ä»‹ç´¹ï¼Œé¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹
        if (locationDesc) {
            const descDiv = document.createElement('div');
            descDiv.style.cssText = "padding:10px; background:#f9f9f9; color:#666; font-size:0.9em; margin-bottom:10px; border-radius:5px;";
            descDiv.innerText = locationDesc;
            birdListDiv.appendChild(descDiv);
        }

        if (recentBirds.length > 0) {
            const h = document.createElement('div'); h.innerHTML = "ğŸŸ¢ <b>è¿‘æœŸ eBird å›å ±</b>";
            h.style.cssText = "padding:10px 5px; color:#27ae60; border-bottom:1px solid #eee; font-size:0.9em;";
            birdListDiv.appendChild(h);
            renderAccordionBirdList(recentBirds, birdListDiv, false);
        }

        if (potentialBirds.length > 0) {
            const h = document.createElement('div'); h.innerHTML = "ğŸŒŸ <b>æ­¤åœ°ä»£è¡¨/å¸¸è¦‹é³¥ç¨®</b>";
            h.style.cssText = "padding:10px 5px; color:#d35400; border-bottom:1px solid #eee; font-size:0.9em; margin-top:15px;";
            birdListDiv.appendChild(h);
            const formatted = potentialBirds.map(p => ({ name:p.name, sciName:p.sci||"", date:"å¸¸å¹´å¯è¦‹", wikiImg:p.wikiImg, wikiDesc:p.wikiDesc }));
            renderAccordionBirdList(formatted, birdListDiv, true);
        }
        
        if (recentBirds.length === 0 && potentialBirds.length === 0) {
            birdListDiv.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>æš«ç„¡è³‡æ–™</div>";
        }
    }

    function renderAccordionBirdList(birds, container, isPot = false) {
        const seen = new Set();
        birds.forEach((b, i) => {
            if(seen.has(b.name)) return; seen.add(b.name);
            const row = document.createElement('div'); row.className = 'bird-row';
            const cid = `c-${isPot?'p':'r'}-${i}-${Math.random().toString(36).substr(2,5)}`;
            let tDisp = b.date || "è¿‘æœŸå›å ±";
            if(tDisp.includes('T') || tDisp.includes(':')) {
                const d = new Date(tDisp);
                // è™•ç†ç„¡æ•ˆæ—¥æœŸ
                if(!isNaN(d.getTime())) {
                     tDisp = d.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit' });
                }
            }
            row.innerHTML = `<div class="bird-header" onclick="document.getElementById('${cid}').classList.toggle('show')">
                <img class="bird-thumb-small" src="${b.wikiImg||DEFAULT_IMG}">
                <div style="flex-grow:1; margin-left:10px;"><div style="font-weight:bold;">${b.name}</div><div style="font-size:0.8em;color:#666;">${b.sciName}</div></div>
                <div style="text-align:right; margin-right:5px;"><div style="font-size:0.75em;color:#888;">${tDisp}</div><div style="color:#ccc;">â–¼</div></div>
            </div><div id="${cid}" class="bird-detail-content"><img class="large-bird-img" src="${b.wikiImg||DEFAULT_IMG}"><div style="padding:10px;font-size:0.9em;color:#555;">${b.wikiDesc||"æš«ç„¡ä»‹ç´¹"}</div></div>`;
            container.appendChild(row);
        });
    }

    async function fetchWeatherHourly(lat, lng) {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,weathercode&forecast_days=2&timezone=auto`);
        const data = await res.json(); weatherDataHourly = data.hourly;
        const bar = document.getElementById('weather-color-bar'); bar.innerHTML = '';
        for(let i=0; i<48; i++) { const s = document.createElement('div'); s.className = 'weather-color-segment'; s.style.backgroundColor = (weatherDataHourly.weathercode[i]===0)?'#ffa726':'#b0bec5'; bar.appendChild(s); }
        updateWeatherDisplay(0);
    }

    function updateWeatherDisplay(i) {
        if(!weatherDataHourly.time) return;
        const code = weatherDataHourly.weathercode[i];
        const codeMap = { 0:"æ™´æœ—", 1:"å¤§è‡´æ™´æœ—", 2:"å¤šé›²", 3:"é™°å¤©", 45:"éœ§", 48:"éœ§", 51:"æ¯›æ¯›é›¨", 61:"å°é›¨", 63:"é›¨", 80:"é™£é›¨", 95:"é›·é›¨" };
        document.getElementById('weather-temp').innerText = `${weatherDataHourly.temperature_2m[i]}Â°C`;
        document.getElementById('weather-desc').innerText = codeMap[code] || "å¤šé›²";
        document.getElementById('weather-time-display').innerText = `æ™‚é–“: ${new Date(weatherDataHourly.time[i]).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})}`;
    }

    function renderBirdSearchList(birds) {
        const stats = {}; birds.forEach(b => { if(!stats[b.name]) stats[b.name]={d:b, locations:new Set()}; stats[b.name].locations.add(b.locName); });
        displayedBirds = Object.values(stats).sort((a,b)=>b.locations.size-a.locations.size);
        loadMoreBirds();
    }

    function loadMoreBirds() {
        const container = document.getElementById('bird-search-list');
        const total = displayedBirds.length;
        if (currentDisplayCount >= total) return; 

        const nextBatch = displayedBirds.slice(currentDisplayCount, currentDisplayCount + BATCH_SIZE);
        
        nextBatch.forEach(item => {
            const bird = item.d;
            const locationCount = item.locations.size;
            const div = document.createElement('div');
            div.className = 'bird-grid-item';
            
            let imgSrc = (bird.wikiImg && bird.wikiImg !== "None" && bird.wikiImg !== "") ? bird.wikiImg : DEFAULT_IMG;

            div.innerHTML = `
                <img src="${imgSrc}" onerror="this.onerror=null; this.src='${DEFAULT_IMG}';">
                <div class="bird-name-overlay">
                    <div>${bird.name}</div>
                    <div class="grid-badge">${locationCount}è™•å‡ºæ²’</div>
                </div>`;
                
            div.onclick = () => { 
                const birdRecords = allBirdsData.filter(b => b.name === bird.name);
                switchTab('record'); 
                renderMarkers(birdRecords, true); 
                renderFilteredLocationList(birdRecords, bird.name);
                if(window.innerWidth<=768) toggleMobileSearch(false);
                const bounds = new google.maps.LatLngBounds();
                birdRecords.forEach(b => bounds.extend({lat: b.lat, lng: b.lng}));
                map.fitBounds(bounds);
            };
            container.appendChild(div);
        });
        currentDisplayCount += nextBatch.length;
    }

    function renderFilteredLocationList(birdRecords, birdName) {
        const container = document.getElementById('location-list-container');
        container.innerHTML = `<div style="padding:10px; background:#e3f2fd; font-weight:bold; color:#1976d2; border-radius:5px; margin-bottom:10px;">
            ğŸ¯ æ›¾å‡ºç¾ã€Œ${birdName}ã€çš„åœ°é»ï¼š
        </div>`;
        const groups = {};
        birdRecords.forEach(b => { if (!groups[b.locName]) { groups[b.locName] = { lat: b.lat, lng: b.lng, count: 0 }; } groups[b.locName].count++; });
        Object.entries(groups).sort((a, b) => b[1].count - a[1].count).forEach(([name, data]) => {
            const div = document.createElement('div'); div.className = 'loc-card';
            div.innerHTML = `<div class="loc-name">${name}</div><div class="loc-meta"><span style="color:#d32f2f;">åœ¨æ­¤æœ‰ ${data.count} ç­†ç´€éŒ„</span></div>`;
            div.onclick = () => { map.setCenter({ lat: data.lat, lng: data.lng }); map.setZoom(15); openLocationDetail(name, data.lat, data.lng); };
            container.appendChild(div);
        });
    }

    function resetApp() { 
        document.querySelectorAll('.bird-grid-item').forEach(el => el.classList.remove('active'));
        if (currentTab === 'record') renderMarkers(allBirdsData, false); 
        else renderHotSpotMapMarkers();
        map.setZoom(8); map.setCenter({lat:23.97, lng:120.98}); 
        goBackToPreviousState(); 
    }
    
    function goBackToPreviousState() { 
        document.getElementById('location-detail-panel').style.display='none'; 
        if (currentTab === 'record') {
            document.getElementById('location-list-container').style.display = 'block';
            renderLocationList(allBirdsData);
        } else {
            document.getElementById('hotspot-list-container').style.display = 'block';
        }
    }
    
    function toggleMobileSearch(s) { document.getElementById('mobile-search-panel').classList.toggle('active', s); }

    window.onload = initMap;
</script>
</body>
</html>
