<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>台灣賞鳥地圖 - 台北熱點</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #sidebar { width: 350px; background: #f8f9fa; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #map { flex: 1; }
        .sidebar-header { padding: 20px; background: #2c3e50; color: white; }
        #bird-list { flex: 1; overflow-y: auto; padding: 10px; }
        .bird-item { 
            background: white; margin-bottom: 10px; padding: 15px; border-radius: 8px; 
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        .bird-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .bird-grid { display: flex; align-items: center; gap: 15px; }
        .bird-grid img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; }
        .bird-name { font-weight: bold; font-size: 1.1em; color: #333; }
        .bird-sci { font-size: 0.85em; color: #666; font-style: italic; }
        #loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">
        <h2>台北賞鳥熱點</h2>
        <p id="data-status">載入中...</p>
    </div>
    <div id="bird-list">
        <div id="loading">正在讀取鳥類資料...</div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 初始化地圖 (以台北為中心)
    const map = L.map('map').setView([25.0330, 121.5654], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let allBirdsData = [];
    let currentDisplayCount = 0;
    const batchSize = 15;
    const birdListElement = document.getElementById('bird-list');

    // 抓取 JSON 資料
    fetch('static/birds_data.json')
        .then(response => {
            if (!response.ok) throw new Error('找不到資料檔案');
            return response.json();
        })
        .then(data => {
            // 修正點：從 data.recent 獲取陣列
            allBirdsData = data.recent || []; 
            document.getElementById('data-status').textContent = `本日發現 ${allBirdsData.length} 筆記錄`;
            birdListElement.innerHTML = '';
            
            renderBirdList();
            renderMarkers();
        })
        .catch(err => {
            console.error('Error:', err);
            birdListElement.innerHTML = `<div style="color:red; padding:20px;">無法載入資料: ${err.message}</div>`;
        });

    function renderBirdList() {
        const nextBatch = allBirdsData.slice(currentDisplayCount, currentDisplayCount + batchSize);
        
        nextBatch.forEach(bird => {
            const div = document.createElement('div');
            div.className = 'bird-item';
            
            // 修正點：使用與 JSON 一致的 wikiImg 欄位
            const imgUrl = bird.wikiImg || 'https://via.placeholder.com/60';
            
            div.innerHTML = `
                <div class="bird-grid">
                    <img src="${imgUrl}" alt="${bird.name}">
                    <div class="bird-grid-info">
                        <div class="bird-name">${bird.name}</div>
                        <div class="bird-sci">${bird.sciName}</div>
                    </div>
                </div>
            `;
            
            div.onclick = () => {
                map.flyTo([bird.lat, bird.lng], 16);
                L.popup()
                    .setLatLng([bird.lat, bird.lng])
                    .setContent(`
                        <div style="width:200px">
                            <b style="font-size:1.2em">${bird.name}</b><br>
                            <span style="color:#666">${bird.locName}</span><br>
                            <img src="${imgUrl}" style="width:100%; margin-top:10px; border-radius:4px;">
                            <p style="font-size:12px; margin-top:8px">${bird.wikiDesc || ''}</p>
                        </div>
                    `)
                    .openOn(map);
            };
            
            birdListElement.appendChild(div);
        });
        
        currentDisplayCount += nextBatch.length;
    }

    function renderMarkers() {
        allBirdsData.forEach(bird => {
            L.marker([bird.lat, bird.lng])
                .addTo(map)
                .bindPopup(`<b>${bird.name}</b><br>${bird.locName}`);
        });
    }

    // 滾動加載更多
    birdListElement.addEventListener('scroll', () => {
        if (birdListElement.scrollTop + birdListElement.clientHeight >= birdListElement.scrollHeight - 50) {
            if (currentDisplayCount < allBirdsData.length) {
                renderBirdList();
            }
        }
    });
</script>

</body>
</html>
