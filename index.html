<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£å¥½é³¥ - Taiwan Good Bird</title>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f0f2f5;}
        .container { display: flex; height: 100vh; position: relative; width: 100vw; }
        
        /* å·¦å´æ¬„ä½ (é›»è…¦ç‰ˆé è¨­) */
        .sidebar-left { 
            width: 340px; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #ddd; 
            z-index: 20; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
            height: 100%; 
            flex-shrink: 0; 
            position: relative; 
        }
        
        /* åœ°åœ–å€åŸŸ */
        #map { flex-grow: 1; height: 100%; z-index: 1; }
        
        /* å³å´æ¬„ä½ (æœå°‹) */
        .sidebar-right { 
            width: 340px; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #ddd; 
            z-index: 20; 
            flex-shrink: 0; 
            transition: transform 0.3s; 
            height: 100%; 
        }

        /* é›»è…¦ç‰ˆæŒ‰éˆ• (æ‰‹æ©Ÿéš±è—) */
        .home-btn { position: absolute; top: 10px; left: 360px; z-index: 10; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; border: 2px solid white; display: flex; align-items: center; white-space: nowrap; }
        .home-btn:hover { background: #34495e; transform: scale(1.05); }

        /* æ‰‹æ©Ÿç‰ˆæœå°‹æŒ‰éˆ• */
        .mobile-search-toggle { 
            display: none; 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            z-index: 3000; 
            background: #ffc107; 
            color: #333; 
            padding: 10px 15px; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            border: 2px solid white; 
            align-items: center; 
        }
        
        .mobile-search-close { display: none; background: #eee; border: none; padding: 10px; text-align: center; font-weight: bold; color: #555; cursor: pointer; border-bottom: 1px solid #ddd; }

        /* é›»è…¦ç‰ˆåˆ‡æ›æŒ‰éˆ• (æ‰‹æ©Ÿç‰ˆå·²éš±è—) */
        .toggle-btn-circle {
            display: none; 
        }

        /* å…§å®¹æ¨£å¼ */
        .tab-group { display: flex; background: #f0f0f0; padding: 5px; gap: 5px; border-bottom: 1px solid #ddd; flex-shrink: 0;}
        .tab-btn { flex: 1; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; color: #555; background: transparent; transition: 0.2s; }
        .tab-btn.active { background: #3498db; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .location-list { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; padding-bottom: 100px; }
        .loc-card { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; background: #fff; border-left: 5px solid #ddd;}
        .loc-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .loc-meta { font-size: 0.85em; color: #666; display: flex; justify-content: space-between; }
        .hotspot-group-title { font-weight:bold; margin: 15px 0 5px 0; color: #555; border-bottom: 2px solid #eee; padding: 5px 5px 5px 0;}
        
        /* è©³æƒ…é çµæ§‹ */
        .loc-detail-view { 
            padding: 0; 
            display: none; 
            flex-direction: column; 
            height: 100%; 
            overflow: hidden; 
        }
        
        /* å…§å®¹æ²å‹•å®¹å™¨ */
        .detail-scroll-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 150px; 
            -webkit-overflow-scrolling: touch;
        }
        
        .weather-box { background: white; border: 1px solid #ddd; color: #333; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); flex-shrink: 0; }
        .weather-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        .weather-main-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;}
        .temp-big { font-size: 2.2em; font-weight: bold; color: #2c3e50; display:flex; align-items:center; gap:10px;}
        .weather-timeline-container { position: relative; margin-top: 15px; }
        .weather-color-bar { display: flex; height: 12px; width: 100%; border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .weather-color-segment { flex: 1; height: 100%; }
        input[type=range] { width: 100%; cursor: pointer; margin: 0; display: block; }
        .time-ticks { display: flex; justify-content: space-between; margin-top: 5px; color: #888; font-size: 0.75em; position: relative; padding: 0 2px; }
        .tick-mark { position: relative; text-align: center; width: 20px;}
        .tick-mark::before { content: '|'; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); color: #ccc; font-size: 0.8em; }
        .weather-time-label { font-size: 0.9em; text-align: center; margin-top: 10px; font-weight: bold; color: #3498db; background: #f0f8ff; padding: 5px; border-radius: 5px; }

        #detail-bird-list { 
            flex-grow: 0; 
            overflow-y: visible; 
            min-height: 0; 
            padding-bottom: 0;
        }
        
        .bird-row { border-bottom: 1px solid #f0f0f0; transition: 0.3s; background: white; border-radius: 5px; margin-bottom: 5px; overflow: hidden;}
        .bird-header { display: flex; align-items: center; padding: 10px; cursor: pointer; }
        .bird-thumb-small { width: 45px; height: 45px; border-radius: 5px; object-fit: contain; background: #eee; border: 1px solid #ddd;}
        .bird-detail-content { display: none; padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; }
        .bird-detail-content.show { display: block; animation: slideDown 0.3s ease-out; }
        .intro-text { font-size: 0.9em; color: #555; line-height: 1.5; margin-top: 10px; max-height: 150px; overflow-y: auto;}
        .large-bird-img { width: 100%; border-radius: 8px; margin-top: 5px; object-fit: cover; max-height: 200px;}
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .search-header { background: #ffc107; padding: 15px; text-align: center; font-weight: bold; color: #333; flex-shrink: 0;}
        .bird-grid { flex-grow: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: 100px; gap: 8px; align-content: start;}
        
        .bird-grid-item { 
            position: relative; width: 100%; height: 100%; border-radius: 6px; overflow: hidden; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background: #eee;
            display: flex; flex-direction: column;
        }
        .bird-grid-item img { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            background-color: #f0f0f0; 
            transition: transform 0.3s; display: block; flex-grow: 1; 
        }
        .bird-grid-item .bird-name-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: white; font-weight: bold; text-align: center; 
            opacity: 0; transition: opacity 0.3s; 
            padding: 5px; font-size: 0.85em; 
            pointer-events: none; z-index: 2; 
            background: rgba(0,0,0,0.6); 
        }
        .bird-grid-item:hover .bird-name-overlay { opacity: 1; }
        .grid-badge { background: rgba(255, 193, 7, 0.9); color: #333; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; margin-top: 5px;}
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; font-weight: bold; color: #555; }
        .back-btn { 
            margin: 10px 15px 0 15px; 
            flex-shrink: 0; 
            cursor: pointer; background: #e0f7fa; border: none; color: #006064; font-weight: bold; font-size: 1em; display: flex; align-items: center; padding: 10px; border-radius: 5px; width: auto; transition: 0.2s;
        }
        .potential-badge { background: #fff3e0; color: #e65100; padding: 10px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid #ff9800; font-size: 0.9em; line-height: 1.5; }

        /* --- ğŸŒŸ RWD éŸ¿æ‡‰å¼ App æ¨¡å¼ï¼šä¸Šä¸‹åˆ†å‰²ä½ˆå±€ (30% / 70%) --- */
        @media (max-width: 768px) {
            .container { flex-direction: column; } 
            
            /* 1. åœ°åœ–åœ¨ä¸Šæ–¹ï¼Œå›ºå®šé«˜åº¦ 30% */
            #map { 
                width: 100%; 
                height: 30vh; /* ğŸŒŸ èª¿æ•´ç‚º 30% */
                order: 1; 
                flex-shrink: 0;
            }
            
            /* 2. ä¸‹æ–¹åˆ—è¡¨ï¼Œä½”æ“šå‰©é¤˜ç©ºé–“ (70%) */
            .sidebar-left { 
                width: 100%; 
                height: 70vh; /* ğŸŒŸ èª¿æ•´ç‚º 70% */
                order: 2; 
                border-right: none; 
                border-top: 1px solid #ddd; 
                box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
                border-radius: 0; 
                margin-top: 0; 
                position: relative; 
                z-index: 10;
            }
            
            /* 3. éš±è—åˆ‡æ›æŒ‰éˆ• */
            .toggle-btn-circle { display: none !important; }

            .mobile-search-toggle { display: flex; } 
            .mobile-search-close { display: block; }

            .loc-detail-view {
                display: none; height: 100%; 
                overflow: hidden; padding: 0; 
            }
            
            /* æœå°‹é é¢ä¾èˆŠå…¨è¢å¹•è¦†è“‹ */
            .sidebar-right { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                z-index: 4000; 
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar-right.active { transform: translateX(0); }
            
            .home-btn { display: none; } 
            
            .bird-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .bird-grid-item { height: auto; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            .bird-grid-item img { height: 80px; background: #f0f0f0; }
            .bird-grid-item .bird-name-overlay {
                position: static; opacity: 1; background: white; color: #333; text-shadow: none; height: auto; padding: 5px 2px; justify-content: start;
            }
            .bird-grid-item .bird-name-overlay div:first-child { font-size: 0.9em; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
            .grid-badge { font-size: 0.65em; padding: 1px 5px; background: #eee; color: #666; }
        }
    </style>
</head>
<body>

<div id="loading">è¼‰å…¥æœ€æ–°é³¥æ³èˆ‡ç†±é»...</div>

<div class="home-btn" onclick="resetApp()">âŒ‚ å…¨è¦½æ¨¡å¼</div>
<div class="mobile-search-toggle" onclick="toggleMobileSearch(true)">ğŸ” æœå°‹é³¥ç¨®</div>

<div class="container">
    <div class="sidebar-left" id="sidebar-left-panel">
        <div class="toggle-btn-circle" id="sidebar-toggle-btn" onclick="toggleSidebarHeight()">
            <span id="toggle-icon">â¬†</span>
        </div>

        <div class="tab-group">
            <button class="tab-btn" onclick="switchTab('record')">ç´€éŒ„åœ°é»</button>
            <button class="tab-btn active" onclick="switchTab('hotspot')">å°ç£è³é³¥ç†±é»</button>
        </div>
        <div id="location-list-container" class="location-list" style="display:none;"></div>
        <div id="hotspot-list-container" class="location-list"></div>
        
        <div id="location-detail-panel" class="loc-detail-view">
            <button class="back-btn" onclick="goBackToPreviousState()">â† è¿”å›åˆ—è¡¨</button>
            
            <div class="detail-scroll-wrapper">
                <h2 id="detail-loc-name" style="margin:10px 0 10px 0; font-size:1.3em;">åœ°é»åç¨±</h2>
                
                <div class="weather-box">
                    <div class="weather-header">
                        <div style="font-weight:bold; color:#666;">å¤©æ°£é å ± (48å°æ™‚)</div>
                        <div id="weather-desc" style="font-weight:bold; color:#333;">--</div>
                    </div>
                    <div class="weather-main-info">
                        <div class="temp-big">
                            <span id="weather-icon-main">â˜ï¸</span>
                            <span id="weather-temp">--Â°C</span>
                        </div>
                        <div style="text-align:right; font-size:0.9em; color:#666;">
                            <div id="weather-wind">é¢¨é€Ÿ: --</div>
                            <div id="weather-rain-prob">é™é›¨æ©Ÿç‡: --%</div>
                        </div>
                    </div>
                    <div class="weather-timeline-container">
                        <div id="weather-color-bar" class="weather-color-bar"></div>
                        <input type="range" id="weather-slider" min="0" max="47" value="0" step="1">
                        <div class="time-ticks">
                            <span class="tick-mark">ç¾</span><span class="tick-mark">6h</span><span class="tick-mark">12h</span><span class="tick-mark">18h</span><span class="tick-mark">24h</span><span class="tick-mark">30h</span><span class="tick-mark">36h</span><span class="tick-mark">42h</span><span class="tick-mark">48h</span>
                        </div>
                    </div>
                    <div class="weather-time-label" id="weather-time-display">æ‹–å‹•æ»‘æ¡¿æŸ¥çœ‹é å ±</div>
                </div>
                
                <div id="bird-list-title" style="display:none;">æ­¤åœ°è¿‘æœŸå‡ºæ²’é³¥é¡</div>
                <div id="detail-bird-list"></div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="sidebar-right" id="mobile-search-panel">
        <button class="mobile-search-close" onclick="toggleMobileSearch(false)">âœ• é—œé–‰æœå°‹</button>
        <div class="search-header">ğŸ¦ æœå°‹é³¥ç¨® (æ»‘é¼ æ‡¸åœæŸ¥çœ‹)</div>
        <div id="bird-search-list" class="bird-grid"></div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCU8mrNF6149G8L2fDAh1fsQIDQ25ZoGhw"></script>

<script>
    let map;
    let allBirdsData = [];
    let hotspotsDB = {};
    let markers = [];
    let markerCluster = null;
    let markerMap = {}; 
    let infoWindow;
    let weatherDataHourly = {}; 
    let currentMode = 'ALL'; 
    let previousMarkersData = []; 
    let currentTab = 'hotspot'; 
    let isSidebarExpanded = false; 
    
    const BATCH_SIZE = 30;

    const BIRD_ICON_PATH = "M22.1,7c-0.8,0.4-1.6,0.6-2.5,0.7c0.9-0.6,1.6-1.4,2-2.5c-0.9,0.5-1.8,0.9-2.8,1.1c-0.8-0.9-2-1.4-3.2-1.4 c-2.4,0-4.4,2-4.4,4.4c0,0.3,0,0.7,0.1,1c-3.7-0.2-6.9-1.9-9.1-4.6c-0.4,0.7-0.6,1.5-0.6,2.2c0,1.5,0.8,2.9,1.9,3.7 c-0.7,0-1.4-0.2-2-0.6c0,0,0,0,0,0.1c0,2.1,1.5,3.9,3.5,4.3c-0.4,0.1-0.8,0.2-1.2,0.2c-0.3,0-0.6,0-0.9-0.1 c0.6,1.8,2.2,3,4.2,3.1c-1.5,1.2-3.4,1.9-5.4,1.9c-0.4,0-0.7,0-1.1-0.1c2,1.3,4.3,2,6.8,2c8.1,0,12.6-6.7,12.6-12.6 c0-0.2,0-0.4,0-0.6C20.7,8.6,21.5,7.9,22.1,7z";

    const COUNTY_COLORS = {
        "åŸºéš†å¸‚": "#2c3e50", "å°åŒ—å¸‚": "#e74c3c", "æ–°åŒ—å¸‚": "#d35400", "æ¡ƒåœ’å¸‚": "#f1c40f",
        "æ–°ç«¹ç¸£å¸‚": "#27ae60", "è‹—æ —ç¸£": "#16a085", "å°ä¸­å¸‚": "#2980b9", "å½°åŒ–ç¸£": "#8e44ad",
        "å—æŠ•ç¸£": "#2c3e50", "é›²æ—ç¸£": "#e67e22", "å˜‰ç¾©ç¸£å¸‚": "#c0392b", "å°å—å¸‚": "#f39c12",
        "é«˜é›„å¸‚": "#2ecc71", "å±æ±ç¸£": "#3498db", "å®œè˜­ç¸£": "#1abc9c", "èŠ±è“®ç¸£": "#9b59b6",
        "å°æ±ç¸£": "#e74c3c", "é›¢å³¶": "#7f8c8d"
    };

    const DEFAULT_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjOTk5Ij48cGF0aCBkPSJNNDk2IDM4NEgxMjhWODBjMC04LjgtNy4yLTE2LTE2LTE2SDgwYy04LjggMC0xNiA3LjItMTYgMTZ2MzJjMCA4LjggNy4yIDE2IDE2IDE2aDQ4MGM4LjggMCAxNi03LjIgMTYtMTZ2LTMyYzAtOC44LTcuMi0xNi0xNi0xNnptMC0xNjBoLTgwYy04LjggMC0xNiA3LjItMTYgMTZ2MzJjMCA4LjggNy4yIDE2IDE2IDE2aDgwYzguOCAwIDE2LTcuMiAxNi0xNnYtMzJjMC04LjgtNy4yLTE2LTE2LTE2em0wLTE2MGgtODBjLTguOCAwLTE2IDcuMi0xNiAxNnYzMmMwIDguOCA3LjIgMTYgMTYgMTZoODBjOC44IDAgMTYtNy4yIDE2LTE2VjgwYzAtOC44LTcuMi0xNi0xNi0xNnoiLz48L3N2Zz4=";
    const LOADING_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48cGF0aCBmaWxsPSIjZmZjMTA3IiBkPSJNMjUgNTBBMjUgMjUgMCAwIDEgMCAyNSAyNSAyNSAwIDAgMSAyNSA1MHptMC00NUEyMCAyMCAwIDEgMCA0NSA1IDIwIDIwIDAgMCAwIDI1IDV6IiBvcGFjaXR5PSIuMiIvPjxwYXRoIGZpbGw9IiNmZmMxMDciIGQ9Ik0yNSA1VjBBMjUgMjUgMCAwIDEgNTAgMjVoLTVBMjAgMjAgMCAwIDAgMjUgNXoiPjxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDI1IDI1IiB0bz0iMzYwIDI1IDI1IiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPjwvcGF0aD48L3N2Zz4=";

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.973875, lng: 120.982024 },
            zoom: 8,
            mapTypeControl: false,
            streetViewControl: false
        });
        infoWindow = new google.maps.InfoWindow();
        
        fetchBirds();
        document.getElementById('weather-slider').addEventListener('input', function() {
            updateWeatherDisplay(this.value);
        });
        const gridContainer = document.getElementById('bird-search-list');
        gridContainer.addEventListener('scroll', () => {
            if (gridContainer.scrollTop + gridContainer.clientHeight >= gridContainer.scrollHeight - 100) {
                loadMoreBirds();
            }
        });
    }

    function toggleSidebarHeight() {
        const sidebar = document.getElementById('sidebar-left-panel');
        const icon = document.getElementById('toggle-icon');
        
        if (isSidebarExpanded) {
            sidebar.style.height = '30vh'; 
            icon.innerText = 'â¬†'; 
            isSidebarExpanded = false;
        } else {
            sidebar.style.height = '90vh'; 
            icon.innerText = 'â¬‡'; 
            isSidebarExpanded = true;
        }
    }

    function toggleMobileSearch(show) {
        const panel = document.getElementById('mobile-search-panel');
        if (show) panel.classList.add('active');
        else panel.classList.remove('active');
    }

    async function fetchBirds() {
        try {
            const response = await fetch('./static/birds_data.json');
            if (!response.ok) throw new Error("ç„¡æ³•è®€å–æœ¬åœ°è³‡æ–™");
            
            const rawData = await response.json();
            if (rawData.hotspots) {
                allBirdsData = rawData.recent;
                hotspotsDB = rawData.hotspots;
            } else {
                allBirdsData = rawData;
                hotspotsDB = {}; 
            }
            document.getElementById('loading').style.display = 'none';
            renderHotSpotsList(); 
            switchTab('hotspot');
            renderBirdSearchList(allBirdsData);
        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerText = "è«‹å…ˆåœ¨æœ¬æ©ŸåŸ·è¡Œ update_data.py ç”¢ç”Ÿè³‡æ–™";
        }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if (infoWindow) infoWindow.close();

        if (tab === 'record') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('location-list-container').style.display = 'block';
            document.getElementById('hotspot-list-container').style.display = 'none';
            renderLocationList(allBirdsData);
            renderMarkers(allBirdsData);
        } else {
            document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            document.getElementById('location-list-container').style.display = 'none';
            document.getElementById('hotspot-list-container').style.display = 'block';
            renderHotSpotMapMarkers();
        }
        document.getElementById('location-detail-panel').style.display = 'none';
    }

    function renderHotSpotMapMarkers() {
        if (markerCluster) markerCluster.clearMarkers();
        markers.forEach(m => m.setMap(null));
        markers = [];
        markerMap = {}; 

        for (const [city, spots] of Object.entries(hotspotsDB)) {
            const cityColor = COUNTY_COLORS[city] || "#2980b9"; 

            spots.forEach(spot => {
                const marker = new google.maps.Marker({
                    position: { lat: spot.lat, lng: spot.lng },
                    title: spot.name,
                    icon: {
                        path: BIRD_ICON_PATH, 
                        scale: 1.2, 
                        fillColor: cityColor, 
                        fillOpacity: 1, 
                        strokeWeight: 1, 
                        strokeColor: "white",
                        anchor: new google.maps.Point(12, 12) 
                    }
                });
                
                marker.addListener("click", () => openDirectHotspot(spot.name, spot.lat, spot.lng, spot.potential));
                markers.push(marker);
                markerMap[spot.name] = marker; 
            });
        }

        markerCluster = new markerClusterer.MarkerClusterer({ 
            map, 
            markers,
            renderer: {
                render: ({ count, position }) => {
                    return new google.maps.Marker({
                        position,
                        label: { text: String(count), color: "white", fontSize: "14px", fontWeight: "bold" },
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 18, 
                            fillColor: "#333", 
                            fillOpacity: 0.9,
                            strokeWeight: 2,
                            strokeColor: "white"
                        },
                        zIndex: Number(google.maps.Marker.MAX_ZINDEX) + count,
                    });
                }
            }
        });
    }

    function renderHotSpotsList() {
        const container = document.getElementById('hotspot-list-container');
        container.innerHTML = '';
        
        for (const [city, spots] of Object.entries(hotspotsDB)) {
            const cityColor = COUNTY_COLORS[city] || "#ddd";
            const titleDiv = document.createElement('div');
            titleDiv.className = 'hotspot-group-title';
            titleDiv.style.borderLeft = `5px solid ${cityColor}`;
            titleDiv.style.paddingLeft = "10px";
            titleDiv.innerText = city;
            container.appendChild(titleDiv);
            
            spots.forEach(spot => {
                const div = document.createElement('div');
                div.className = 'loc-card hotspot-card';
                div.style.borderLeftColor = cityColor;
                div.innerHTML = `<div class="loc-name">${spot.name}</div><div style="font-size:0.85em; color:#666;">${spot.desc}</div>`;
                div.onclick = () => openDirectHotspot(spot.name, spot.lat, spot.lng, spot.potential);
                container.appendChild(div);
            });
        }
    }

    function openDirectHotspot(name, lat, lng, potentialBirds) {
        map.setCenter({ lat: lat, lng: lng });
        map.setZoom(16);
        if (window.selectedMarker) window.selectedMarker.setMap(null);
        window.selectedMarker = new google.maps.Marker({
            map: map, position: { lat: lat, lng: lng }, animation: google.maps.Animation.DROP
        });
        infoWindow.setContent(`<div style="padding:5px;"><div style="font-weight:bold; font-size:1.1em; margin-bottom:5px;">${name}</div><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" style="color:#3498db; text-decoration:none;">ğŸ“ åœ¨ Google Maps é–‹å•Ÿ</a></div>`);
        infoWindow.open(map, window.selectedMarker);
        openLocationDetail(name, lat, lng, true, potentialBirds);
    }

    function renderMarkers(birds, isHighlight = false) {
        if (markerCluster) markerCluster.clearMarkers();
        markers.forEach(m => m.setMap(null));
        markers = [];
        markerMap = {};
        if (isHighlight) previousMarkersData = birds;
        const locationGroups = {};
        birds.forEach(bird => {
            const key = `${bird.lat},${bird.lng}`;
            if (!locationGroups[key]) locationGroups[key] = { lat: bird.lat, lng: bird.lng, locName: bird.locName, speciesSet: new Set() };
            locationGroups[key].speciesSet.add(bird.name);
        });
        Object.values(locationGroups).forEach(group => {
            const speciesCount = group.speciesSet.size;
            const marker = new google.maps.Marker({
                position: { lat: group.lat, lng: group.lng },
                map: map,
                title: `${group.locName} (${speciesCount} ç¨®é³¥é¡)`,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: isHighlight ? 14 : 10,
                    fillColor: isHighlight ? "#d35400" : "#FF5722",
                    fillOpacity: 0.9, strokeWeight: 2, strokeColor: "white",
                },
                label: { text: speciesCount.toString(), color: "white", fontSize: "12px", fontWeight: "bold" },
                zIndex: isHighlight ? 100 : 1
            });
            marker.addListener("click", () => {
                infoWindow.setContent(`<div style='padding:5px; font-weight:bold;'>${group.locName}</div>`);
                infoWindow.open(map, marker);
                openLocationDetail(group.locName, group.lat, group.lng);
            });
            markers.push(marker);
            markerMap[group.locName] = marker; 
        });
    }

    function renderLocationList(birds) {
        const container = document.getElementById('location-list-container');
        container.innerHTML = '';
        const locGroups = {};
        birds.forEach(bird => {
            if (!locGroups[bird.locName]) locGroups[bird.locName] = { lat: bird.lat, lng: bird.lng, birds: [] };
            if (!locGroups[bird.locName].birds.some(b => b.name === bird.name)) locGroups[bird.locName].birds.push(bird);
        });
        const sortedLocs = Object.entries(locGroups).sort((a, b) => b[1].birds.length - a[1].birds.length);
        sortedLocs.forEach(([locName, data]) => {
            const div = document.createElement('div');
            div.className = 'loc-card';
            div.innerHTML = `<div class="loc-name">${locName}</div><div class="loc-meta"><span>ç´€éŒ„: ${data.birds.length} ç¨®</span><span style="color:#3498db;">è©³æƒ… â†’</span></div>`;
            div.onclick = () => {
                map.setCenter({ lat: data.lat, lng: data.lng });
                map.setZoom(14);
                const targetMarker = markerMap[locName];
                if (targetMarker) google.maps.event.trigger(targetMarker, 'click');
                else openLocationDetail(locName, data.lat, data.lng);
            };
            container.appendChild(div);
        });
    }

    function openLocationDetail(locName, lat, lng, isHotHotSpot = false, potentialBirds = []) {
        document.getElementById('location-list-container').style.display = 'none';
        document.getElementById('hotspot-list-container').style.display = 'none';
        
        const panel = document.getElementById('location-detail-panel');
        panel.style.display = 'flex';
        
        document.getElementById('detail-loc-name').innerText = locName;
        
        fetchWeatherHourly(lat, lng);
        
        const birdListDiv = document.getElementById('detail-bird-list');
        birdListDiv.innerHTML = '';

        let birdsHere = [];
        if (isHotHotSpot) {
            birdsHere = allBirdsData.filter(b => Math.abs(b.lat - lat) < 0.015 && Math.abs(b.lng - lng) < 0.015);
        } else {
            birdsHere = allBirdsData.filter(b => b.locName === locName);
        }

        if (birdsHere.length > 0) {
            const recentTitle = document.createElement('div');
            recentTitle.innerHTML = "ğŸŸ¢ <b>è¿‘æœŸ eBird å›å ± (è¿‘30å¤©)</b>";
            recentTitle.style.cssText = "padding:10px 5px; color:#27ae60; border-bottom:2px solid #eee; margin-top:10px;";
            birdListDiv.appendChild(recentTitle);
            renderAccordionBirdList(birdsHere, birdListDiv);
        } else {
            const noData = document.createElement('div');
            noData.innerHTML = "<div style='color:#999; padding:10px; text-align:center; font-size:0.9em;'>â˜ï¸ è¿‘ 30 å¤©å°šç„¡ eBird å›å ±</div>";
            birdListDiv.appendChild(noData);
        }

        if (isHotHotSpot && potentialBirds && potentialBirds.length > 0) {
            const staticTitle = document.createElement('div');
            staticTitle.innerHTML = "ğŸŒŸ <b>è©²åœ°å¸¸é§/ä»£è¡¨æ€§é³¥ç¨® (åœ–é‘‘)</b>";
            staticTitle.style.cssText = "padding:10px 5px; color:#d35400; border-bottom:2px solid #eee; margin-top:20px; background:#fff8e1;";
            birdListDiv.appendChild(staticTitle);

            const dummyBirds = potentialBirds.map((pb, idx) => ({ 
                id: `potential-${idx}`, 
                name: pb.name, 
                sciName: pb.sci, 
                speciesCode: `pot-${idx}`, 
                date: pb.note || "å¸¸å¹´å¯è¦‹",
                wikiImg: pb.wikiImg, 
                wikiDesc: pb.wikiDesc
            }));
            renderAccordionBirdList(dummyBirds, birdListDiv);
        }
    }

    function goBackToPreviousState() {
        document.getElementById('location-detail-panel').style.display = 'none';
        
        if (window.selectedMarker) window.selectedMarker.setMap(null);
        if (infoWindow) infoWindow.close();

        if (currentTab === 'record') {
            document.getElementById('location-list-container').style.display = 'block';
        } else {
            document.getElementById('hotspot-list-container').style.display = 'block';
        }

        if (currentMode === 'SEARCH') {
            renderMarkers(previousMarkersData, true);
            if (previousMarkersData.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                previousMarkersData.forEach(b => bounds.extend({ lat: b.lat, lng: b.lng }));
                map.fitBounds(bounds);
            }
        }
    }

    function renderAccordionBirdList(birdsHere, targetContainer = null) {
        const birdListDiv = targetContainer || document.getElementById('detail-bird-list');
        const uniqueBirds = [];
        const seen = new Set();
        birdsHere.forEach(b => { if (!seen.has(b.name)) { uniqueBirds.push(b); seen.add(b.name); } });
        
        uniqueBirds.forEach((bird, index) => {
            const container = document.createElement('div');
            container.className = 'bird-row';
            
            const safeId = bird.id || `unknown-${index}`; 
            const imgId = `accord-img-${index}-${safeId}`; 
            const thumbId = `thumb-${index}-${safeId}`;
            const contentId = `content-${index}-${safeId}`;
            
            let imgSrc = (bird.wikiImg && bird.wikiImg !== "None" && bird.wikiImg !== "") ? bird.wikiImg : DEFAULT_IMG;
            const descText = bird.wikiDesc || "æš«ç„¡è©³ç´°ä»‹ç´¹ã€‚";

            container.innerHTML = `
                <div class="bird-header" onclick="toggleBirdDetail('${contentId}')">
                    <img id="${thumbId}" class="bird-thumb-small" src="${imgSrc}" onerror="this.onerror=null; this.src='${DEFAULT_IMG}';">
                    <div style="flex-grow:1;">
                        <div style="font-weight:bold;">${bird.name}</div>
                        <div style="font-size:0.8em; color:#666;">${bird.sciName}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.75em; color:#888;">${bird.date.includes('å¸¸å¹´') || bird.date.includes('å†¬å­£') ? bird.date : bird.date.substring(5, 10)}</div>
                        <div style="color:#aaa;">â–¼</div>
                    </div>
                </div>
                <div id="${contentId}" class="bird-detail-content">
                    <div style="text-align:center;"><img id="${imgId}" class="large-bird-img" src="${imgSrc}" onerror="this.onerror=null; this.src='${DEFAULT_IMG}';"></div>
                    <div class="intro-text">${descText}</div>
                </div>
            `;
            birdListDiv.appendChild(container);
        });
    }

    function toggleBirdDetail(contentId) {
        document.querySelectorAll('.bird-detail-content').forEach(el => { if (el.id !== contentId) el.classList.remove('show'); });
        const target = document.getElementById(contentId);
        target.classList.toggle('show');
    }

    async function fetchWeatherHourly(lat, lng) {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,weathercode,windspeed_10m,precipitation_probability&forecast_days=2&timezone=auto`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            weatherDataHourly = data.hourly;
            const barContainer = document.getElementById('weather-color-bar');
            barContainer.innerHTML = ''; 
            for (let i = 0; i < 48; i++) {
                const code = weatherDataHourly.weathercode[i];
                const color = getWeatherColor(code);
                const seg = document.createElement('div');
                seg.className = 'weather-color-segment';
                seg.style.backgroundColor = color;
                barContainer.appendChild(seg);
            }
            const slider = document.getElementById('weather-slider');
            slider.value = 0;
            updateWeatherDisplay(0);
        } catch (e) { document.getElementById('weather-temp').innerText = "N/A"; }
    }
    function getWeatherColor(code) {
        if (code === 0) return '#ffa726'; 
        if (code >= 1 && code <= 3) return (code === 1 ? '#ffee58' : '#b0bec5'); 
        if (code >= 51) return '#4fc3f7'; 
        return '#b0bec5'; 
    }
    function getWeatherIcon(code) {
        if (code === 0) return 'â˜€ï¸';
        if (code === 1) return 'ğŸŒ¤ï¸';
        if (code === 2) return 'â›…';
        if (code === 3) return 'â˜ï¸';
        if (code >= 51 && code <= 67) return 'ğŸŒ§ï¸';
        if (code >= 80 && code <= 99) return 'â›ˆï¸';
        return 'â˜ï¸';
    }
    function updateWeatherDisplay(index) {
        if (!weatherDataHourly.time) return;
        const i = parseInt(index);
        const timeStr = weatherDataHourly.time[i];
        const dateObj = new Date(timeStr);
        const displayTime = dateObj.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit' });
        const code = weatherDataHourly.weathercode[i];
        const temp = weatherDataHourly.temperature_2m[i];
        const wind = weatherDataHourly.windspeed_10m[i];
        const rainProb = weatherDataHourly.precipitation_probability ? weatherDataHourly.precipitation_probability[i] : 0;
        document.getElementById('weather-temp').innerText = `${temp}Â°C`;
        document.getElementById('weather-wind').innerText = `é¢¨é€Ÿ: ${wind} km/h`;
        document.getElementById('weather-rain-prob').innerText = `é™é›¨æ©Ÿç‡: ${rainProb}%`;
        document.getElementById('weather-time-display').innerText = `é å ±æ™‚é–“: ${displayTime}`;
        document.getElementById('weather-icon-main').innerText = getWeatherIcon(code);
        const codeMap = { 0: "æ™´æœ—", 1: "å¤§è‡´æ™´æœ—", 2: "å¤šé›²", 3: "é™°å¤©", 45:"èµ·éœ§", 51:"æ¯›æ¯›é›¨", 61:"ä¸‹é›¨", 63:"å¤§é›¨", 80:"é™£é›¨", 95:"é›·é›¨" };
        document.getElementById('weather-desc').innerText = codeMap[code] || "å¤šé›²";
    }

    function renderBirdSearchList(birds) {
        const container = document.getElementById('bird-search-list');
        container.innerHTML = '';
        currentDisplayCount = 0; 
        const birdStats = {}; 
        birds.forEach(bird => {
            if (!birdStats[bird.name]) birdStats[bird.name] = { data: bird, locations: new Set() };
            birdStats[bird.name].locations.add(bird.locName);
        });
        displayedBirds = Object.values(birdStats).sort((a, b) => {
            const countDiff = b.locations.size - a.locations.size; 
            if (countDiff !== 0) return countDiff;
            return a.data.name.localeCompare(b.data.name);
        });
        loadMoreBirds();
    }
    
    function loadMoreBirds() {
        const container = document.getElementById('bird-search-list');
        const total = displayedBirds.length;
        if (currentDisplayCount >= total) return; 
        
        const nextBatch = displayedBirds.slice(currentDisplayCount, currentDisplayCount + BATCH_SIZE);
        
        nextBatch.forEach(item => {
            const bird = item.data;
            const locationCount = item.locations.size;
            const imgId = `grid-img-${bird.speciesCode}`;
            const div = document.createElement('div');
            div.className = 'bird-grid-item';
            
            let imgSrc = (bird.wikiImg && bird.wikiImg !== "None" && bird.wikiImg !== "") ? bird.wikiImg : DEFAULT_IMG;

            div.innerHTML = `
                <img id="${imgId}" 
                     src="${imgSrc}" 
                     onerror="this.onerror=null; this.src='${DEFAULT_IMG}';"
                >
                <div class="bird-name-overlay">
                    <div>${bird.name}</div>
                    <div class="grid-badge">${locationCount}è™•å‡ºæ²’</div>
                </div>`;
                
            div.onclick = () => {
                if (currentTab === 'hotspot') switchTab('record');
                currentMode = 'SEARCH';
                currentSearchBird = bird.name;
                document.querySelectorAll('.bird-grid-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                const filtered = allBirdsData.filter(b => b.name === bird.name);
                renderMarkers(filtered, true);
                if (filtered.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    filtered.forEach(b => bounds.extend({ lat: b.lat, lng: b.lng }));
                    map.fitBounds(bounds);
                    if(filtered.length === 1 && map.getZoom() > 14) map.setZoom(14);
                }
                if (window.innerWidth <= 768) {
                    toggleMobileSearch(false); 
                    const sidebar = document.getElementById('sidebar-left-panel');
                }
            };
            container.appendChild(div);
        });
        currentDisplayCount += nextBatch.length;
    }
    
    function resetApp() {
        currentMode = 'ALL';
        currentSearchBird = null;
        previousMarkersData = [];
        document.querySelectorAll('.bird-grid-item').forEach(el => el.classList.remove('active'));
        if (currentTab === 'record') renderMarkers(allBirdsData, false); 
        else renderHotSpotMapMarkers();
        map.setZoom(8);
        map.setCenter({ lat: 23.973875, lng: 120.982024 });
        goBackToPreviousState(); 
    }
    window.onload = initMap;
</script>
</body>
</html>
